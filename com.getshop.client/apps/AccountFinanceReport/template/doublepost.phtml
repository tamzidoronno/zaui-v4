<?
/* @var $this ns_e6570c0a_8240_4971_be34_2e67f0253fd3\AccountFinanceReport */
if (isset($_POST['data']['value']) && $_POST['data']['value']) {
    $_SESSION['ns_e6570c0a_8240_4971_be34_2e67f0253fd3_paymentid'] = $_POST['data']['value'];
}

$name = $this->getNameOfPaymentMethod($this->getApi()->getStoreApplicationPool()->getApplication($_SESSION['ns_e6570c0a_8240_4971_be34_2e67f0253fd3_paymentid']));

$start = $this->getStart();
$end = $this->getEnd();
$dayIncomes = $this->getApi()->getOrderManager()->getPaymentRecords($_SESSION['ns_e6570c0a_8240_4971_be34_2e67f0253fd3_paymentid'], $start, $end);
$isLocked = $this->getApi()->getOrderManager()->isLocked($end);
$bankAccountClosed = $this->getApi()->getOrderManager()->isBankAccountClosed($end);
$isShowingExTaxes = $this->isShowingIncTaxes();
$invoiceActivated = $_SESSION['ns_e6570c0a_8240_4971_be34_2e67f0253fd3_paymentid'] == "70ace3f0-3981-11e3-aa6e-0800200c9a66";
$autoCloseActivated = $this->getApi()->getOrderManager()->getOrderManagerSettings()->autoCloseFinancialDataWhenCreatingZReport;
$monthHasPassed = strtotime($end) < time();

$selectedYear = date('Y', strtotime($start));
$selectedMonth = date('m', strtotime($start));

$errors  = array();
foreach ($dayIncomes as $dayIncome) {
    if ($dayIncome->errorMsg) {
        $errors[] = $dayIncome->errorMsg;
    } else {
        foreach ($dayIncome->dayEntries as $entry) {
            if ($entry->isTaxTransaction && $this->isShowingIncTaxes()) {
                continue;
            }
            $allAccountNumbers[] = $entry->accountingNumber;
        }
    }
}

if (count($errors)) {
    echo "<h1>".$this->__f("There are a few errors you have to sort out first.")."</h1>";
    foreach ($errors as $error) {
        echo "<div style='color: red; margin-left: 50px;'>- ".$error."</div>";
    }
    return;
}

$accounts = array_unique($allAccountNumbers);
sort($accounts);
$store = $this->getApi()->getStoreManager()->getMyStore();
$storeYear = date('Y', strtotime($store->rowCreatedDate));
echo "<script>";
    echo "storeCreatedYear = ".$storeYear.";";
    echo "storeCreatedMonth = ".date('m', strtotime($store->rowCreatedDate)).";";
echo "</script>";
?>
<div class="infoheader">
    <div class="divededheader">
        <?
        echo "<div class='head'>".$this->__f("Transaction report for")." $name</div>";
        echo $this->__f("Periode").": ".date('d.m.Y', strtotime($start))." - ".date('d.m.Y', strtotime($end));
        ?>
        <div>
            <? echo $this->__f("You can click on each row to inspect each day and see how the amounts are for each account."); ?>
        </div>

        <br/><b>Please select: </b>
        <br/>
        <div gstype='form' method='showMonth'>
            <select  gsname='month' class='gsniceselect1 timeperiode'>
                <option value="1" <? echo $selectedMonth == 1 ? 'selected="true"' :""; ?>>Jan</option>
                <option value="2" <? echo $selectedMonth == 2 ? 'selected="true"' :""; ?>>Feb</option>
                <option value="3" <? echo $selectedMonth == 3 ? 'selected="true"' :""; ?>>Mar</option>
                <option value="4" <? echo $selectedMonth == 4 ? 'selected="true"' :""; ?>>Apr</option>
                <option value="5" <? echo $selectedMonth == 5 ? 'selected="true"' :""; ?>>May</option>
                <option value="6" <? echo $selectedMonth == 6 ? 'selected="true"' :""; ?>>June</option>
                <option value="7" <? echo $selectedMonth == 7 ? 'selected="true"' :""; ?>>July</option>
                <option value="8" <? echo $selectedMonth == 8 ? 'selected="true"' :""; ?>>Aug</option>
                <option value="9" <? echo $selectedMonth == 9 ? 'selected="true"' :""; ?>>Sep</option>
                <option value="10" <? echo $selectedMonth == 10 ? 'selected="true"' :""; ?>>Oct</option>
                <option value="11" <? echo $selectedMonth == 11 ? 'selected="true"' :""; ?>>Nov</option>
                <option value="12" <? echo $selectedMonth == 12 ? 'selected="true"' :""; ?>>Dec</option>
            </select>
            -
            <select gsname='year' class='gsniceselect1 timeperiode'>
                <?
                $nextYear = date('Y') + 1;
                for ($i=$storeYear; $i<=$nextYear; $i++) {
                    $year = $i;
                    $selected = $year == $selectedYear ? 'selected="true"' :""; 
                    echo "<option $selected year='$year'>$year</option>";
                }
                ?>
            </select>
            -
            <div gstype='submit' class='shop_button showresultbutton'><? echo $this->__f("Show"); ?></div>
        </div>
    </div>
    
    <div class="divededheader">
        <?
        if ($invoiceActivated && $monthHasPassed) {
            echo "<div class='head'>".$this->__f("Bank account")."</div>";
            if ($bankAccountClosed) {
            ?>
                <div><? echo $this->__f("Bank account has been closed for this periode"); ?></div>
            <?
            } else {
            ?>
                <div>
                    <? echo $this->__f("When a bank account is open for the periode you can register manually payments for the periode. This is normally done with manually mark invoices as paid."); ?>
                    <br/>
                    <br/><div class="shop_button" gsclick="closeBankAccount"> <? echo $this->__f("Close bank account"); ?></div>
                </div>
            <?
            }
        }
        ?>
    </div>
    
</div>

<?
if ($this->extramessage) {
?>
    <div>
        <?
        echo $this->extramessage;
        ?>
    </div>
<?
}

echo "<div class='outer'>";

    echo "<div class='row header'>";
        echo "<div class='col orderid header'>Date</div>";
        foreach ($accounts as $account) {
            echo "<div class='col $account header'>".$account;
                echo "<div class='accountdesc'>".$this->getAccountDescription($account)."</div>";;
            echo "</div>";
        }
        echo "<div class='col controlsum'>Zero Check</div>";
    echo "</div>";
    
    foreach ($dayIncomes as $dayIncome) {
         echo "<div class='row' >";
            echo "<div class='inner_row' gsclick='showDetailedReport'  start='$dayIncome->start' end='$dayIncome->end' >";
                $isLocked = $dayIncome->isFinal ? "<i class='fa fa-lock'></i>" : "";
                $grouped = $this->groupOnAccounting($dayIncome->dayEntries);
                echo "<div class='col orderid'>$isLocked ".date('d.m.Y H:i', strtotime($dayIncome->start))." - ".date('H:i', strtotime($dayIncome->end))."</div>";
                $controlSum = 0;
                foreach ($accounts as $account) {
                    if (isset($grouped[$account]) && $grouped[$account]) {
                        $sum[$account] = @$sum[$account] + $grouped[$account];
                    }

                    if (isset($grouped[$account]) && $grouped[$account]) {
                        $controlSum += ($grouped[$account]);
                    }

                    $val = isset($grouped[$account]) && $grouped[$account] ? $grouped[$account] : "&nbsp;";
                    echo "<div class='col $account'>".round($val,2)."</div>";
                }

                if ($controlSum < 0.00001 && $controlSum > -0.00001 ) {
                    $controlSum = 0;
                }
                echo "<div class='col controlsum'>".$controlSum."</div>";
            echo "</div>";
            
            if ($isSuportingDirectTransfer && $dayIncome->isFinal) {
                $checked = count($dayIncome->accountingTransfer) ? " <i class='fa fa-check' title='This day has already been transferred'></i>" : "";
                $askForPassword = count($dayIncome->accountingTransfer) ? " gs_precheck='app.AccountFinanceReport.askForPassword'" : "";
                echo "<div class='col' gsclick='startUploadOfData' $askForPassword start='$dayIncome->start' end='$dayIncome->end' >".'<i class="gs_shop_small_icon fa fa-upload"></i>'.$checked."</div>";
                
            }

        echo "</div>";
    }
    
    echo "<div class='row summaryrow'>";

        echo "<div class='col orderid'>Total</div>";

        foreach ($accounts as $account) {
            $val = isset($sum[$account]) && $sum[$account] ? $sum[$account] : "&nbsp;";
            echo "<div gsclick='showSummaryForAccount' account='$account' class='col $account'>".round($val,2)."</div>";
        }

    echo "</div>";

    
echo "</div>";

?>
<script>
    $(document).ready(function() {
        app.AccountFinanceReport.changePeriodeOptions();
    })
</script>