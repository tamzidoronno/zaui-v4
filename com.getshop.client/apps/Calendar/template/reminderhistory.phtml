<? 
$histories = $this->getHistory();

function createStatus($emailStatus, $extraText) {
    if ($emailStatus != null) {
        $title = $extraText." | ".$emailStatus->text;
        
        $color = '#000';
        
        if ($emailStatus->status == "QUEUED" || $emailStatus->status == "SENDING") {
            $icon =  "fa-spinner fa-spin";
            $color = '#000';
        }
        
        if ($emailStatus->status == "STOPPED_FRAMEWORK_IN_DEBUG_MODE" || $emailStatus->status == "FAILED_TO_SEND") {
            $icon = "fa-frown-o";
            $color = 'red';
        }
        
        if ($emailStatus->status == "DELIVERED") {
            $icon = "fa-smile-o";
            $color = 'green';
        }
        
        echo "<span style='padding: 5px; color: $color' title='$title'><i class='fa $icon' style='$color'></i></span>";
    }
}

if (count($histories)) { ?>
    <div> History </div>
    <?
    foreach ($histories as $hist) {
        echo "<div class='reminderhistoryrow'>";
        $emailOrSms = ($hist->byEmail) ? "email" : "sms";
        
        echo $hist->rowCreatedDate . " - Sent <b>$emailOrSms</b>";
        
        foreach ($hist->users as $user) {
            $extra = $hist->byEmail ? $user->emailAddress : $user->cellPhone;
            echo "<div style='position: relative; border: solid 1px #888; padding: 5px; margin-top: 10px; '>";
                echo  $user->fullName . " - " . $extra;
                echo "<div style='position: absolute; right: 5px; top: 5px; background-color: #FFF;'>";
                    createStatus(@$hist->invoiceEmailStatus->{$user->id}, "Invoice email address");
                    createStatus(@$hist->emailStatus->{$user->id}, "User email address");
                    createStatus(@$hist->smsStatus->{$user->id}, "Sms Status");
                echo "</div>";
            echo "</div>";
        }
        
        echo "<br><b>Subject</b>: " . $hist->subject;
        echo "<br><b>Text</b><br><div style='margin-left: 20px;'> " . $hist->text . "</div>";
        echo "</div>";
    }
    ?>
<? } ?>