<?
/* @var $this \ns_b7fb195b_8cea_4d7b_922e_dee665940de2\InvoicingOverdueList */
$overDueInvoices = $this->getOverDueInvoices();
$debtCollectors = (array)$this->getApi()->getStoreApplicationPool()->getActivatedApplications("DebtCollectorApplication");
$hasDebtCollector = sizeof($debtCollectors) > 0;

if( $_SESSION['massupdatewh'] == 'yes') $mwh = true;
if($mwh)
{
?>
<script>

function registerWHManualPayment(duedate,orderid,amount,button)
{
    console.log('Manual payment registrtation: date:' + duedate + '; orderid: ' + orderid + '; amount: ' + amount);

    var data = {};
    data.orderid = orderid;
    data.date = duedate;
    data.amount = amount;
    data.comment = '';
    data.localCurrency = $(tab).find('.localcurrencyvalue').val();
    data.agio = $(tab).find('.disaglo').val();
    data.type = $(tab).find('.manualregisterpaymenttype').val();

    var event = thundashop.Ajax.createEvent(null, "addTransactionRecord", $(button), data);
    event['synchron'] = true;

    thundashop.Ajax.post(event, function(res) {
        console.log('We have an answer from the backend: ' + res);
    });
}

</script>


<?php
} // end if massupdatewh
?>
<div class="duerow header">
    <div class="col incrementalOrderId"><? echo $this->__f("Order id"); ?></div>
    <div class="col name"><? echo $this->__f("Name"); ?></div>
    <div class="col duedate"><? echo $this->__f("Due date"); ?></div>
    <div class="col totalamount"><? echo $this->__f("Total"); ?></div>
    <div class="col totalpaid"><? echo $this->__f("Paid"); ?></div>
    <div class="col remaining"><? echo $this->__f("Remaining"); ?></div>
    <?php
    if($mwh) echo '<div class="col remaining">WHUPDATE</div>';
    if($hasDebtCollector) {
        ?>
        <div class="col todebt"><? echo $this->__f(""); ?></div>
        <?php
    }
    ?>
</div>

<?
$totalOrderAmount = 0;
$totalOrderPaid = 0;

foreach ($overDueInvoices as $order) {
    $dueDays = $this->calculateDaysSince($order->dueDate);
    $color = "blue";
    $color = $dueDays < 1 ? "gray" : $color;
    $color = $dueDays > 14 ? "yellow" : $color;
    $color = $dueDays > 30 ? "red" : $color;
    
    $debtcollectorText = "";
    foreach($order->shipmentLog as $slog) {
        if($slog->type == "debtCollector") {
            $debtcollectorText .= "Sent to debt collector at : " . date("d.m.Y H:i", strtotime($slog->date)) . "\r\n";
        }
    }
    

    // MANUAL HACK FOR WH INVOICES THAT HAVE NOT BEEN PAID EVER
    if($mwh)
    {
      echo '<div class="duerow" onclick="registerWHManualPayment(\''. date('d.m.Y', strtotime($order->dueDate)) .'\',\''. $order->id .'\',\''. ($amount - $paidAmount) .'\')">RUN FOR THIS ORDER</div>';
      echo '<pre style="display:none;">'. print_r($order,1) .'</pre>';
    }

?>
    <div class="duerow  <? echo $color; ?>" duedays='<? echo $dueDays; ?>'>
        <a href='/invoicing.php?page=orderviewpage&orderid=<? echo $order->id; ?>&tab=paymenthistory' target='_new'>
            <div class="col incrementalOrderId"><? echo $order->incrementOrderId; ?>
                <?php
                if($order->internalComment) {
                    echo '<i class="fa fa-comment" title="'.$order->internalComment.'"></i>';
                }
                ?>
            </div>
            <div class="col name"><? echo $order->cart->address->fullName; ?></div>
            <div class="col duedate">
                <? echo date('d.m.Y', strtotime($order->dueDate)); ?>
                <span class="overduedays"> ( <? echo $dueDays . " " . $this->__f("days") ?> )</span>
            </div>
            <div class="col totalamount">
                <?
                $amount = $this->getTotalAmountForOrder($order);
                $totalOrderAmount += $amount;
                echo $amount;
                ?>
            </div>
            <div class="col totalpaid">
                <?
                $paidAmount = $this->getTotalPaidAmount($order);
                $totalOrderPaid += $paidAmount;
                echo $paidAmount;
                ?>
            </div>

            <div class="col remaining">
                <?
                echo $amount - $paidAmount;
                ?>
            </div>
            <?php
            if($hasDebtCollector) {
                
                $appName = $debtCollectors[0]->appName;
                $appId = $debtCollectors[0]->id;
                $nameSpace = "ns_" . str_replace("-","_",$appId) . "\\" . $appName;
                $orderId = $order->incrementOrderId;
                ?>
                <div class="col todebt" style='float:right;'>
                    <a href='/scripts/transferToDebtCollector.php?app=<?php echo $nameSpace; ?>&orderid=<?php echo $orderId; ?>' target='_debtnew'>
                        <?php if($debtcollectorText) { ?>
                            <i title='<?php echo $debtcollectorText; ?>' class='fa fa-forward' style='color:#bbb;'></i>
                        <?php } else { ?>
                            <i title='Send to debt collector' class='fa fa-forward'></i>
                        <?php } ?>
                    </a>
                </div>
            <?php } ?>
        </a>
    </div>

    <?
}
?>
<script>
    app.InvoicingOverdueList.listLoaded();
</script>