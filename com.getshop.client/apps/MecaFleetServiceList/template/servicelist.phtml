<?
/* @var $this ns_e4a506de_4702_4d82_8224_f30e5fdb1d2e\MecaFleetServiceList */
$cars = $this->getApi()->getMecaManager()->getCarsServiceList();
?>
<div class='servicerow header'>
    <div></div>
    <div></div>
    <div>Regnr </div>
    <div>KM/Service</div>
    <div>Måneder til neste service</div>
    <div>Flåte</div>
    <div></div>
</div>
<?
foreach ($cars as $car) {
    $fleet = $this->getApi()->getMecaManager()->getFleetByCar($car);
    $nextServiceDate = isset($car->nextService) ? date('d/m-Y', strtotime($car->nextService)) : "";
    
    $agreementStatus = "disabled";
    $agreementStatus = isset($car->needAttentionToService) && $car->needAttentionToService ? "red" : $agreementStatus;
    $agreementStatus = isset($car->nextServiceAgreed) && $car->nextServiceAgreed != null && !@$car->nextServiceAcceptedByCarOwner ? "yellow" : $agreementStatus;
    $agreementStatus = isset($car->nextServiceAgreed) && $car->nextServiceAgreed != null && @$car->nextServiceAcceptedByCarOwner ? "green" : $agreementStatus;
    
    
    ?>
        <div class='servicerow'>
            <div>
                <i class="fa fa-bullseye <? echo $agreementStatus; ?>"></i>
            </div>
            <div>
                <a href='/?page=<? echo $car->pageId;?>'><i class='gs_shop_small_icon fa fa-edit'></i></a>
            </div>
            <div><? echo $car->licensePlate; ?></div>
            <div><? echo isset($car->kilometersToNextService) ? $car->kilometersToNextService: 'N/A'; ?></div>
            <div><? echo isset($car->monthsToNextService) ? $car->monthsToNextService." ( $nextServiceDate ) " : "N/A"; ?> </div>
            <div><? echo isset($fleet->name) ? $fleet->name : "N/A"; ?> </div>
            
            <div>
                <?
                if ($agreementStatus === "red") {
                    echo "<span class='shop_button' gs_show_modal='agreeForService' carid='$car->id' type='service'>Kall inn til service</span>";
                }
                
                if ($agreementStatus === "yellow") {
                    echo "<span class='shop_button' gs_show_modal='agreeForService' carid='$car->id' type='service'>Bytt dato</span>";
                }
                ?>
            </div>
            
            
            <?
            if ($agreementStatus === "yellow") {
                echo '<div class="details">';
                $text = isset($car->serviceDateRejected) && $car->serviceDateRejected ? "<span style='color: red'>Tidspunktet passet ikke for bileier, foreslå et annet tidspunkt</span>" : "Venter på bekreftelse fra bileier";
                echo "$text. <br/> Foreslått dato: ".date('d/m-Y H:i', strtotime($car->nextServiceAgreed));
                if (isset($car->newSuggestedDate) && $car->newSuggestedDate) {
                    echo "<br/> Bileier ønsker dato: ".date('d/m-Y H:i', strtotime($car->newSuggestedDate));
                }
                echo '</div>';
            }
            
            if ($agreementStatus === "green") {
                echo '<div class="details">';
                echo "Bileier har bekreftet servicedato: ".date('d/m-Y H:i', strtotime($car->nextServiceAgreed));
                echo "<br/><span class='shop_button' gsclick='serviceCompleted' carid='$car->id'> Service gjennomført</span>";
                ?>
                <span style='margin-top: 5px;' class="shop_button" gsclick='noShow' carid='<? echo $car->id; ?>' type='control'>No show</span>
                <?
                echo '</div>';
            }
            ?>
            
        </div>
    <?
}
?>