<?
/* @var $this ns_27716a58_0749_4601_a1bc_051a43a16d14\OrderManager */
/* @var $address core_usermanager_data_Address */
/* @var $order core_ordermanager_data_Order */
/* @var $cartItem core_cartmanager_data_CartItem */
if (!isset($_POST['value'])) {
    return;
}

$order = $this->getApi()->getOrderManager()->getOrder($_POST['value']);
if (!$order) {
    echo $this->__f("Order not found");
    return;
}

$canChangeOrder = $this->canChangeOrder($order);

$orderStatusText = "";
$orderStatusText = $order->status == 1 ? $this->__f("Created") : $orderStatusText;
$orderStatusText = $order->status == 2 ? $this->__f("Waiting for payment") : $orderStatusText;
$orderStatusText = $order->status == 3 ? $this->__f("Payment failed") : $orderStatusText;
$orderStatusText = $order->status == 4 ? $this->__f("Completed") : $orderStatusText;
$orderStatusText = $order->status == 5 ? $this->__f("Canceled") : $orderStatusText;
$orderStatusText = $order->status == 6 ? $this->__f("Sent") : $orderStatusText;
$orderStatusText = $order->status == 7 ? $this->__f("Payment completed") : $orderStatusText;
$orderStatusText = $order->status == 8 ? $this->__f("Capture failed") : $orderStatusText;
        
        
$cart = $order->cart;
?>
<div class='orderoverview' orderId='<? echo $_POST['value']; ?>'>
    <div class='customerdetails'>
        <?
        $address = $order->cart->address;
        ?>
        <div class='gss_label'><? echo $this->__f("Name"); ?></div>
        <div class='gss_label_content'><? echo $address->fullName; ?></div>
        <div class='gss_label'><? echo $this->__f("Email"); ?></div>
        <div class='gss_label_content'><? echo $address->emailAddress; ?></div>
        <div class='gss_label'><? echo $this->__f("Phone"); ?></div>
        <div class='gss_label_content'><? echo $address->phone; ?></div>
        <div class='gss_label'><? echo $this->__f("Order date"); ?></div>
        <div class='gss_label_content'><? echo $order->createdDate; ?></div>
        
        <div class='gss_label'><? echo $this->__f("Payment"); ?></div>
        <div class='gss_label_content'>
            <?
            $changeText = $canChangeOrder ? "<i class='fa fa-edit gss_changePaymentType'></i> " : "";
            if ($order->payment->paymentType) {
                $paymentApp = new $order->payment->paymentType();
                echo $changeText.$paymentApp->getName();
                echo "<br/>";
            }
            
            

            echo $orderStatusText; ?>
            
            <div class="gss_orderview_available_payments">
                <?
                $paymentsApplications= $this->getApi()->getStoreApplicationPool()->getActivatedPaymentApplications();
                foreach ($paymentsApplications as $app) {
                    $appInstance = $this->getFactory()->getApplicationPool()->createInstace($app);
                    $id = $app->id;
                    if ($appInstance) {
                        echo "<div class='gss_order_view_select_payement_method' payementMethodId='$id'>".$appInstance->getName()."</div>";
                    }
                }
                ?>
            </div>
        </div>
        
        
        <div class='gss_label'><? echo $this->__f("Shipping"); ?></div>
        <div class='gss_label_content'>
            <? 
            echo $address->fullName."<br/>";
            echo $address->address."<br/>"; 
            echo $address->postCode." ".$address->city."<br/>"; 
            ?>
        </div>
    </div>
    
    <div class='gss_label'>
        <? echo $this->__f("Order"); ?>
    </div>
    <?
    foreach ($cart->items as $cartItem) {
//        echo "<div class='gss_label_content'>";
        $editButton = $canChangeOrder ? "<i class='fa fa-edit gss_changeOrderLine'></i>" : "";
        $metaText = $cartItem->product->metaData ? " ( " .$cartItem->product->metaData." )" : "";
        echo "<div class='gss_order_line' cartItemId='".$cartItem->cartItemId."'>".$cartItem->count." x ".$cartItem->product->name." $metaText<span class='gss_order_line_price'>".$cartItem->product->price." $editButton</span></div>";
//        echo "</div>";
    }
    ?>
    <div class='gss_label'>
        <? echo $this->__f("Total price"); ?>
    </div>
    <div class='gss_label_content'>
        <? echo $this->getApi()->getCartManager()->calculateTotalCost($cart); ?>
    </div>
</div>
<br/>

<?
if ($order->transactions) {
    echo "<br/>";
    echo "<b>".$this->__f("Credit card transactions (registered)")."</b>:";
    foreach ($order->transactions as $transaction) {
        echo "<div>&nbsp;&nbsp;Date: ".$transaction->date.", amount: ".$transaction->amount."</div>";
    }
    echo "<br/><br/>";
}
?>

&nbsp;
<div class="gss_button" onclick="$('.gss_more_order_settings').slideDown();">
    <? echo $this->__f("Show more settinsg"); ?>
</div>



<?
if ($canChangeOrder) {
?>
    <div orderId='<? echo $order->id; ?>' class="gss_button gss_mark_order_as_paid">
        <? echo $this->__f("Mark order as paid"); ?>
    </div>
<?
}
?>
<div class="gss_more_order_settings">
    <center>
        <font style="color: red; font-weight: bold;">
        <?
        echo $this->__f("Please be careful here, this settings should normally be updated automatically.");
        ?>
        </font>
    </center>
    
    
    <div class="textfield gss_setting"  id="isCaptured">
        <span class="title"><?php echo $this->__f("Captured"); ?></span>
        <?
        $class = $order->captured ? "fa-toggle-on" : "fa-toggle-off";
        ?>
        <div class="gss_onoff" gs_model="ordermodel" gs_model_attr="isCaptured">
            Off<i class="fa <? echo $class; ?>"></i>On
        </div>
        <div class="description">
            <?php echo $this->__("Is order captured?"); ?>
        </div>
    </div>

    <div class="textfield gss_setting"  id="isTestOrder">
        <span class="title"><?php echo $this->__f("Test order"); ?></span>
        
        <?
        $class = $order->testOrder ? "fa-toggle-on" : "fa-toggle-off";
        ?>
        <div class="gss_onoff" gs_model="ordermodel" gs_model_attr="isTestOrder">
            Off<i class="fa <? echo $class; ?>"></i>On
        </div>
        
        <div class="description">
            <?php echo $this->__("This is a test order, should not be accounted and is not part of the summaries."); ?>
        </div>
    </div>
    
    <div class="gss_button" gss_value="<? echo $order->id; ?>" gss_method="updateOrder" gss_model="ordermodel" gss_fragment="orderview" gss_view="gss_orderview">
        <? echo $this->__f("Save"); ?>
    </div>
</div>
