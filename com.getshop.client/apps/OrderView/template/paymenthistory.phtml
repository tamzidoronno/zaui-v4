<?
/* @var $this ns_4be8e427_bead_491e_8d9f_7dd16356d8eb\OrderView */
$order = $this->getOrder();
$totalForOrderInLocalCurrency = 0;

if ($order->currency) {
    $totalForOrderInLocalCurrency = $this->getApi()->getOrderManager()->getTotalForOrderInLocalCurrencyById($order->id);
}
?>

<div class="summaryheader"><? echo $this->__f("Payment history"); ?></div>
<?
if (!count($order->orderTransactions)) {
    echo "<div class='warning_not_sent'>";
        echo "<i class='fa fa-warning'></i> ".$this->__f("This order has no payment records");
    echo "</div>";
} else {
    echo "<div class='shipmentlogline'>";
        echo "<div class='date'>".$this->__f("Date")."</div>";
        echo "<div class='amount'>".$this->__f("Amount")."</div>";
        echo "<div class='user'>".$this->__f("By user")."</div>";
        echo "<div class='comment'>".$this->__f("Comment")."</div>";
        echo "<div class='addeddate'>".$this->__f("Date added")."</div>";
    echo "</div>";
    foreach ($order->orderTransactions as $paymentLog) {
        $type = "";
        if ($paymentLog->accountingDetailId) {
            $accountingDetail = $this->getApi()->getProductManager()->getAccountingDetailById($paymentLog->accountingDetailId);
            $type = $accountingDetail->accountNumber . " - " . $accountingDetail->description;
        }
        $user = $this->getApi()->getUserManager()->getUserById($paymentLog->userId);
        echo "<div class='shipmentlogline'>";
            echo "<div class='date'>".date('d.m.Y H:i', strtotime($paymentLog->date))."</div>";
            
            echo "<div class='amount'>";
                echo $paymentLog->amount;
                if ($paymentLog->amountInLocalCurrency) {
                    echo "<br/> Local: ".$paymentLog->amountInLocalCurrency;
                }
                if ($paymentLog->agio) {
                    echo "<br/> Agio: ".$paymentLog->agio;
                }
            echo "</div>";
            
            echo "<div class='user'>".$user->fullName."</div>";
            echo "<div class='comment'>";
                echo $type;
                if ($type && $paymentLog->comment) {
                    echo " / ";
                }
                echo $paymentLog->comment."</div>";
            echo "<div class='addeddate'>".date('d.m.Y H:i', strtotime($paymentLog->rowCreatedDate))."</div>";
        echo "</div>";
    }
}

$accounts = $this->getApi()->getProductManager()->getAccountingAccounts();
$feeAccounts = array();
foreach ($accounts as $account) {
    if ($account->type == "fee") {
        $feeAccounts[] = $account;
    }
}
?>

<div class="manualregisterpayment">

    <h1><? echo $this->__f("Manually register payment"); ?></h1>
    <?
    $now = date('d.m.Y');
    ?>
    <div>
        <?
        if ($feeAccounts) {
            ?>
            <span style='display: inline-block; width: 200px;'>Type</span>
            <?
        }
        ?>
        <span style='display: inline-block; width: 200px;'>Date</span>
        <span style='display: inline-block; width: 200px;'>Comment</span>
        <span style='display: inline-block; width: 200px;'>Value</span>
        <?
        if ($order->currency) {
        ?>
            <span style='display: inline-block; width: 200px;'>Value in local currency</span>
            <span style='display: inline-block; width: 200px;'>Aglo / Disaglo</span>
        <?
        }
        ?>
    </div>
    <?
    if ($feeAccounts) {
        ?>
        <select class="gsniceselect1 manualregisterpaymenttype">
            <option>Normal</option>
            <?
            foreach ($feeAccounts as $account) {
                ?>
                <option value="<? echo $account->id; ?>"><? echo $account->accountNumber." - ".$account->description; ?></option>
                <?
            }
            ?>
        </select>
        <?
    }
    ?>
    <input class="gsniceinput1 manualregisterpaymentdate" value="<? echo $now; ?>"/>
    <input class="gsniceinput1 manualregisterpaymentcomment" placeholder="<? echo $this->__f('Optional comment'); ?>" />
    <input class="gsniceinput1 manualregisterpaymentamount" value="<? echo $order->restAmount; ?>" />
    
    <?
    if ($order->currency) {
        ?>
        <input class="gsniceinput1 localcurrencyvalue" value="" />
        <input class="gsniceinput1 disaglo" inlocalcurrency="<? echo $totalForOrderInLocalCurrency; ?>" value="" />
        <?
    }
    ?>
    <div class="shop_button registerpayment">
        <? 
        echo $this->__f("Register payment");
        ?>
    </div>
    
</div>

<script>
    $('.manualregisterpaymentdate').datepicker({ dateFormat: "dd.mm.yy"});
</script>