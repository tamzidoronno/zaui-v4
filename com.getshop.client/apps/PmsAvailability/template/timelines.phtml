<?
/* @var $this ns_28886d7d_91d6_409a_a455_9351a426bed5\PmsAvailability */

$items = $this->getItems();
$timelines = $this->getData();
$types = $this->getTypes();

foreach ($types as $type) {
?>
   
    <div class='type_line'>
        
        <div class='timeline_item_name'>
            
            <?
            echo "<div class='category_name'>".$type->name."</div>";
            
            foreach ($items as $item) {
                if ($item->bookingItemTypeId != $type->id) {
                    continue;
                }

                echo "<div class='item_name'>".$item->bookingItemName."</div>";
            }
            ?>
        </div>
        
        <div class='timeline'>
            <?
            
            $j = 0;
            foreach ($items as $item) {
                
                if ($item->bookingItemTypeId != $type->id) {
                    continue;
                }
                
                $itemTimeLines = $timelines->itemTimeLines->{$item->id};
                $i = 1;
                
                
                $odd = $j % 2 ? "odd" : "even";
                echo "<div class='timeline_row $odd'>";
                    $prevBookingIds = array();
                    
                    foreach ($itemTimeLines as $time => $data) {
                        $header = "";
                        $colDate = date("d.m.y", $time/1000);
                        $colDate2 = date("m/d/y", $time/1000);
                        
                        if ($j == 0) {
                            $header = "<div class='header col_width'>$colDate</div>";
                        }
                        
                        $nextBookingIds = $this->getNextBookingIds($itemTimeLines, $time);
                        $inPrev = $this->anyMatches($data->bookingIds, $prevBookingIds) ? "connected_with_prev" : "";
                        $inNext = $this->anyMatches($data->bookingIds, $nextBookingIds) ? "connected_with_next" : "";
                        
                        $firstInRow = (!$inPrev && $inNext) || (!$inNext && !$inPrev)  ? "first_in_row" : "";
                        $lastInRow = ($inPrev && !$inNext) || (!$inNext && !$inPrev) ? "last_in_row" : "";
                        
                        $color = $data->state;
                        
                        if ($this->anyMatches($data->bookingIds, $data->virtuallyAssigned) && $data->state === "normal") {
                            $color = "grey";
                        }
                        
                        $containsBooking = count($data->bookingIds) ? "contains_booking" : "";
                        $bookingId = count($data->bookingIds) ? $data->bookingIds[0] : "";
                        
                        if (!$inPrev && $containsBooking) {
                            $header .= $this->createNameOfBooker($data);
                        }
                        
                        $firstInRowOuter = "";
                        if ($firstInRow && $containsBooking) {
                            $firstInRowOuter = $firstInRow."_outer";
                        }
                        
                        $lastInRowOuter = "";
                        if ($lastInRow && $containsBooking) {
                            $lastInRowOuter = $lastInRow."_outer";
                        }
                        
                        $noData = !$containsBooking ? "nodata" : "";
                        $canShowModal = $containsBooking && $data->state == "normal" ? "gs_show_modal='booking_room_view'"  : "";
                        
                        
                        echo "<div typeid='$type->id' col='$i' bookingitemid='$item->id' date='$colDate2' row='$j' ondrop='app.PmsAvailability.onDragDrop(event)' ondragleave='app.PmsAvailability.onDragLeave(event)' ondragover='app.PmsAvailability.onDragOver(event)' class='col_outer $noData $firstInRowOuter $lastInRowOuter'><div ondragstart='app.PmsAvailability.onDragStart(event)' draggable='true' $canShowModal bookingid='$bookingId' roomid='$data->roomId' class='$color timeline_col$i col col_width col_data $containsBooking $inPrev $inNext $firstInRow $lastInRow'>$header</div></div>";
                        $prevBookingIds = $data->bookingIds;
                        $i++;
                    }
                    
                    $j++;
                    
                echo "</div>";

            }
            ?>
        </div>
    </div>
<?
}
?>
<script>
$(document).ready(function() {
    
    var count = $('.timeline_row:first').find('.header').size();
    var width = $(this).find('.timeline_item_name').outerWidth() + 5;
    $(this).find('.timeline').css('width', 'calc(100% - ' + width + "px)");
    width = $(this).find('.timeline').width();
    var size = width/count;
    
    if (size < 64) {
        size = 64;
    }
    
    $(".col_outer").outerWidth(size);
    
    $('.bookername').each(function() {
        var col = $(this).closest('.col_outer').find('.col_data');
        var bookingid = col.attr('bookingid');
        var numberOfBlocks = $('.col_data[bookingid="'+bookingid+'"]').size();
        var marginLeft = size * numberOfBlocks;
        marginLeft -= size;
        $(this).css('margin-right', "-"+marginLeft+"px");
        $(this).find('span').hide();
        $(this).attr('numberofblocks', numberOfBlocks);
        
        if (size > 100 || numberOfBlocks > 1) {
            $(this).find('.fullname').fadeIn();
        } else {
            $(this).find('.acronyme').fadeIn();
        }
    });
});
</script>