<?
/* @var $this \ns_f8cc5247_85bf_4504_b4f3_b39937bd9955\PmsBookingRoomView */
$currentBooking = $this->getBookingEngineBooking();

$types = $this->getTypes();
$items = $this->getItems();

$startDate = $this->convertToJavaDate(strtotime($currentBooking->startDate));
$endDate = $this->convertToJavaDate(strtotime($currentBooking->endDate));

if (isset($_POST['data']['start']) && isset($_POST['data']['end'])) {
    $startDate = $this->convertToJavaDate(strtotime($_POST['data']['start']));
    $endDate = $this->convertToJavaDate(strtotime($_POST['data']['end']));  
}

$availableItems = $this->getApi()->getBookingEngine()->getAllAvailbleItemsWithBookingConsidered($this->getSelectedMultilevelDomainName(), $startDate, $endDate, $currentBooking->id);

function canUseItem($item, $availeableitems) {
    foreach ($availeableitems as $available) {
        if ($available->id == $item->id) {
            return true;
        }
    }
    
    return false;
}
?>
<div class='itemview_inner'>
    <div class='updater'>
        <i class='fa fa-spin fa-spinner'></i> Updating.. please wait..
    </div>
    <div gstype="select" gsname="itemid"><?
        foreach ($types as $type) {
            $useClass = "canNotUse";
            
            $canUseFloating = "canNotUse";
            
            $currentlyUsingFloating = !$currentBooking->bookingItemId  && $currentBooking->bookingItemTypeId == $type->id ? "gs_selected" : "";
            foreach ($items as $item) {
                if ($item->bookingItemTypeId != $type->id) {
                    continue;
                }

                if (canUseItem($item, $availableItems)) {
                    $canUseFloating = "canUse";
                }
            }
        ?>
            <div class='movetotype' typeid='<? echo $type->id; ?>'>
                <div class="headername">
                    <? echo $type->name; ?>
                    <br/><div class='bookingitem floatingbutton <? echo $canUseFloating." ".$currentlyUsingFloating; ?>' gs_value='<? echo $type->id; ?>'><? echo $this->__f("Floating"); ?></div>
                </div>
                <div class="itemselector">
                    <?
                    

                    foreach ($items as $item) {
                        if ($item->bookingItemTypeId != $type->id) {
                            continue;
                        }

                        if (canUseItem($item, $availableItems)) {
                            $useClass = "canUse";
                        }
                    }

                    $currentlyUsing = !$currentBooking->bookingItemId  && $currentBooking->bookingItemTypeId == $type->id ? "gs_selected" : "";
                    foreach ($items as $item) {
                        if ($item->bookingItemTypeId != $type->id) {
                            continue;
                        }
                        $currentlyUsing = $item->id == $currentBooking->bookingItemId ? "gs_selected" : "";
                        $useClass = canUseItem($item, $availableItems) ? "canUse" : "canNotUse";
                        echo "<div class='bookingitem $useClass $currentlyUsing' gs_value='".$type->id."_".$item->id."'>".$item->bookingItemName."</div>";
                    }
                    ?>
                </div>
            </div>
        <?
        }
        ?>
    </div>
</div>

<div class='pricesview'>
    <? $this->includefile("prices"); ?>
</div>