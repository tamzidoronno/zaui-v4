<?
/* @var $this \ns_f8cc5247_85bf_4504_b4f3_b39937bd9955\PmsBookingRoomView */
$pmsBooking = $this->getPmsBooking();
$pmsSelectedRoom = $this->getSelectedRoom();
$booking = $this->getBookingEngineBooking();

$user = $this->getUserForBooking();
$paymentApps = $this->getApi()->getStoreApplicationPool()->getActivatedPaymentApplications();

$options = new stdClass();
$options->cellphone = $user->cellPhone;
$options->prefix = $user->prefix;
$options->message = $this->getApi()->getPmsManager()->getMessage($this->getSelectedMultilevelDomainName(), $pmsBooking->id, "booking_sendpaymentlink");
$options->canCreateOrderAfterStay = true;
$options->postMethod = "doPaymentNormal";
$options->gscallback = "app.PmsSearchBooking.toggleTabClicked";
$options->guestEmail = $user->emailAddress;
$options->invoicenote = $pmsBooking->invoiceNote;

$options->extraArgs = array();
$options->extraArgs['roomid'] = $pmsSelectedRoom->pmsBookingRoomId;
$options->extraArgs['id'] = $booking->id;


?>

<div class="payment_window">
    <?
    echo $this->__f("Here you have an overview of the payments that need to be created and a payment history");
    ?>
</div>
<h2><? echo $this->__f("Need to be paid"); ?></h2>
<?
$showingPaymentProcess = $this->startPaymentProcess();
if ($showingPaymentProcess) {
?>
<div class="payment_options payment_window">
    <div class="h3"><? echo $this->__f("Payment options"); ?></div>
    <div class="options">
        <div class="gs_shop_small_icon payment_option_choice active" payment="paymentproces">
            <div class="activeline"></div>
            <i class="fa fa-check"></i> <? echo $this->__f("Add to process for payment"); ?>
        </div>    
        
        <?
        foreach ($paymentApps as $app) {
            ?>
            <div class="gs_shop_small_icon payment_option_choice" style="font-size: 14px;" payment="<? echo $app->id; ?>">
                <div class="activeline"></div>
                <i class="fa fa-check"></i> <? echo $app->appName; ?>
            </div>        
        <?
        }
        ?>
    </div>
    
    <div class="option_content">
        
        <div class="option_content_div payment_content active" payment="paymentproces">
            You can use this option to merge and split payments. Add as many rooms and items you wish to process, then process them all at one to create one single payment etc.

            <br/>
            <br/><div class="shop_button" synchron="true" gs_callback="app.PmsSearchBooking.ordersTabChanged" id="<? echo $booking->id; ?>" roomid="<? echo $pmsSelectedRoom->pmsBookingRoomId; ?>" gsclick="addCurrentCartForPaymentProcess" >Start payment process</div>  
        </div>
        
        <?
        foreach ($paymentApps as $paymentApp) {
            $instance = $this->getFactory()->getApplicationPool()->createInstace($paymentApp);
            ?>
            <div class="option_content_div payment_content" payment="<? echo $paymentApp->id; ?>" appName="<? echo $paymentApp->appName; ?>">
                <?
                $instance->renderPayment($options);
                ?>
            </div>
            <?
        }
        ?>
    </div>
</div>
    
<?
} else {
?>
    <div class="paymentok payment_window">
        <i class="fa fa-smile-o"></i> <? echo $this->__f("Nothing to pay."); ?>
    </div>
<? 
}
?>

<h2><? echo $this->__f("Payment history"); ?></h2>
<?
if (!count($this->pmsBooking->orderIds)) {
    ?>
    <div class="nopaymentscreatedyet payment_window">  
        <i class="fa fa-frown-o"></i> <? echo $this->__f("There are no payment created yet, create one by using the options above."); ?>
    </div>
    <?
} else {
    echo "<div class='payment_window'>";
    $i = 0;
    foreach ($this->pmsBooking->orderIds as $orderId) {
        $i++;
        $orderPrinter = new ns_f22e70e7_7c31_4c83_a8c1_20ae882853a7\OrderSimplePrinter();
        $orderPrinter->setOrderId($orderId);
        if (count($this->pmsBooking->orderIds) == $i) {
            $orderPrinter->setLastOrderInTable();
        }
        $orderPrinter->renderApplication(true);
    }
    echo "</div>";
}
?>
