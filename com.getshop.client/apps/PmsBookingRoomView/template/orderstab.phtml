
<?
/* @var $this \ns_f8cc5247_85bf_4504_b4f3_b39937bd9955\PmsBookingRoomView */
$methods = (array)$this->getApi()->getStoreApplicationPool()->getActivatedPaymentApplications();
$hasPaymentMethods = false;
if(sizeof($methods) > 0) {
    $hasPaymentMethods = true;
}

$pmsBooking = $this->getPmsBooking();
$pmsSelectedRoom = $this->getSelectedRoom();
$booking = $this->getBookingEngineBooking();
$endDate = null;
foreach($pmsBooking->rooms as $r) {
    if($endDate == null || strtotime($r->date->end) > $endDate) {
        $endDate = strtotime($r->date->end);
    }
}
$user = $this->getUserForBooking();

$totalOnRoom = $pmsSelectedRoom->totalCost;
$totalOrdersRoom = $this->getApi()->getPmsInvoiceManager()->getTotalOnOrdersForRoom($this->getSelectedMultilevelDomainName(), $pmsSelectedRoom->pmsBookingRoomId, true);
$unsettledRoom = $totalOnRoom - $totalOrdersRoom;

$totalOnBooking = $pmsBooking->totalPrice;
$totalMissingOnGroup = 0.0;
$totalNotPaidOnRoom = 0.0;
foreach($pmsBooking->orderIds as $ordId) {
    $order = $this->getApi()->getOrderManager()->getOrder($ordId);
    $totalNotPaidOnRoom += $this->getApi()->getOrderManager()->getTotalAmount($order);
}
$totalMissingOnGroup = $pmsBooking->totalPrice - $totalNotPaidOnRoom;

if(isset($pmsSelectedRoom->hasBeenUpdated) && $pmsSelectedRoom->hasBeenUpdated) {
    ?>
    <div class="kaipal infobox">
        <div class="image sad"></div>
        <div class="textbox">
            <div class="header"><? echo $this->__f("Unsaved changes"); ?></div>
            <div class="text">
                <?
                echo $this->__f("Before you can start handling payments you will have to save all the changes done first. Please save the payments by pressing the button above.");
                ?>    
            </div>
        </div>
    </div>
    <?
    return;
}

$isgroup = "no";
if(sizeof($pmsBooking->rooms) > 1) {
    $isgroup = "yes";
}
?>
<div>
        <?php
        if(!$pmsBooking->createOrderAfterStay) {
            if($hasPaymentMethods) {
            ?>
                <span style='position:absolute; right: 0px; z-index: 5;'>
                    <span class="shop_button createafterstaybtn" isgroup='<?php echo $isgroup; ?>' style='background-color:#a9a535;' roomid='<?php echo $pmsSelectedRoom->pmsBookingRoomId; ?>'><i class=""></i> <? echo $this->__f("Create order after stay"); ?></span>
                    <span class="shop_button addselecteditemstocart" isgroup='<?php echo $isgroup; ?>' roomid='<?php echo $pmsSelectedRoom->pmsBookingRoomId; ?>'><i class=""></i> <? echo $this->__f("Start payment process"); ?></span>
               </span>
            <?php
            }
        } else {
            ?>
            <span class="shop_button createafterstaybtn" isgroup='<?php echo $isgroup; ?>' style='background-color:#a9a535;position:absolute; right: 10px;z-index:2;' roomid='<?php echo $pmsSelectedRoom->pmsBookingRoomId; ?>'><i class=""></i> <? echo $this->__f("Do not create order after stay"); ?></span>
            <?php
            echo "<h1 >An order of " . $pmsBooking->unsettled . " will be created at " . date("d.m.Y", $endDate) . "</h1>";
        }
        ?>
    <div class='insideheader'><? echo $this->__f("Payment overview"); ?></div>
    <div>
        <span class='pricetext'>Total for room</span> <span class='pricetag'><?php echo $totalOnRoom; ?></span>
        <span class='pricetext'>Missing on room</span> <span class='pricetag'><?php echo $unsettledRoom; ?></span>
            <span class='pricetext'>Orders on room</span> <span class='pricetag'><?php echo $totalOrdersRoom; ?></span>
    </div>
    <?php
    if(sizeof($pmsBooking->rooms) > 1) {
        ?>
        <div style='color:#bbb;'>
            <span class='pricetext'>Total for group</span> <span class='pricetag'><?php echo $totalOnBooking; ?></span>
            <span class='pricetext'>Missing on group</span> <span class='pricetag'><?php echo $totalMissingOnGroup; ?></span>
            <span class='pricetext'>Orders for group</span> <span class='pricetag'><?php echo $totalNotPaidOnRoom; ?></span>
        </div>
        <?php
    }
    ?>
</div>

<div class="topbuttons">
    <?
    $this->includefile("orderstabsimple");
    ?>
</div>
<script>
    app.PmsBookingRoomView.activateSelectedTabSubOrders('<? echo $pmsSelectedRoom->pmsBookingRoomId; ?>');
</script>
<?php if($hasPaymentMethods) {Â ?>
    <div class='insideheader'><? echo $this->__f("Payment history"); ?></div>
    <?
    if (!count($this->pmsBooking->orderIds)) {
        echo "No orders has been created yet, create an order by pressing the Start payment process button.";
    } else {
        $this->printOrderList();
    }
} else {
    $this->includefile("nopaymentmethodsyet");
}
?>
    
<style>
    .pricetext { display:inline-block; width: 130px; }
    .pricetag { display:inline-block; width: 80px; }
</style>