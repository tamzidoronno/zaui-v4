<?
/* @var $this \ns_f8cc5247_85bf_4504_b4f3_b39937bd9955\PmsBookingRoomView */
$room = $this->getSelectedRoom();
$pmsBooking = $this->getPmsBooking();
$extraOrders = $this->getApi()->getPmsManager()->getExtraOrderIds($this->getSelectedMultilevelDomainName(), $pmsBooking->id);

$summary = $this->getApi()->getPmsManager()->getSummary($this->getSelectedMultilevelDomainName(), $pmsBooking->id, $room->pmsBookingRoomId);

$orderMissing = 0;
$paymentMissing = 0;

$orders = array();

$allOrderIds = $pmsBooking->orderIds;


if ($extraOrders) {
    $allOrderIds = array_merge($allOrderIds, $extraOrders);
}

$allOrderIds = $this->filterOrderIds($allOrderIds);

$unpaidOrders = false;

foreach ($allOrderIds as $orderId) {
    
    $orderIsForRoom = $this->getApi()->getPmsManager()->doesOrderCorrolateToRoom($this->getSelectedMultilevelDomainName(),$room->pmsBookingRoomId, $orderId);
    
    if(!$orderIsForRoom) {
        continue;
    }
    
    $order = $this->getApi()->getOrderManager()->getOrder($orderId);
    
    if ($order->status != 7) {
        $unpaidOrders = true;
    }
    
    $orders[] = $order;
}

$totalUnpaid = 0;
$totalForRoom = 0;

$distinctDates = array();
$needToCreateOrdersFor = 0;

foreach ($summary->rows as $row) {
    $priceInOrders = $row->createdOrdersFor * $row->countFromOrders;
    
    $priceInBooking = $row->priceInBooking * $row->countFromBooking;
    $missingInOrders = ($row->priceInBooking * $row->countFromBooking) - ($row->createdOrdersFor * $row->countFromOrders);
    
    $totalUnpaid += ($priceInBooking - $priceInOrders);
    $needToCreateOrdersFor += $missingInOrders;
    $totalForRoom += $priceInBooking;
    
    if (!in_array($row->date, $distinctDates)) {
        $distinctDates[] = $row->date;
    }
}

$missingInOrders = round($missingInOrders, 2);
$needToCreateOrdersFor = round($needToCreateOrdersFor, 2);
$totalForRoom = round($totalForRoom, 2);

?>

<div class='insideheader'>Payment summary <? echo $room->guests[0]->name; ?></div>
<div style='font-size: 16px;'>
    <? 
    echo "<div style='color: #8abf45; padding: 5px; padding-left: 10px; '><i class='fa fa-info-circle'></i> ".$this->__f("The total amount for this room is")." ".$totalForRoom."</div>";
    
    if ($needToCreateOrdersFor) {
        echo "<div style='color: #ff9856; padding: 5px; padding-left: 10px; '><i class='fa fa-warning'></i> ".$this->__f("You need to create orders for")." ".$needToCreateOrdersFor."</div>";
    }
    
    if ($orders && $unpaidOrders) {
        echo "<div style='color: #ff5656; padding: 5px; padding-left: 10px; '><i class='fa fa-warning'></i> ".$this->__f("Note, you have unpaid orders... Please make sure that all orders are paid.")."</div>";
    }
    ?>
</div>

<br/>
<br/>
<div>
    <div class='insideheader'><? echo $this->__f("Payments"); ?></div>
    
   <?
   if (!count($orders)) {
        echo "<div style='font-size: 16px; padding-left: 10px;'>";
            echo $this->__f("No orders to show");
        echo "</div>";
   } else {
   ?>
    <div class="row row_payment_status_line header">
        <div class="col col_date"> Created </div>
        <div class="col col_productname"> Payment Type </div>
        <div class="col col_value"> Amount </div>
        <div class="col col_value odd"> Payment Date </div>
        <div class="col col_balance"> Balance </div>
        <div class="col col_orderid odd"> Order id</div>
    </div>
    <?
        usort($orders, array("ns_f8cc5247_85bf_4504_b4f3_b39937bd9955\PmsBookingRoomView", "sortByIncrementalOrderId"));
        foreach ($orders as $order) {
            $paymentDate = $order->status == 7 && $order->paymentDate ? date('d.m.Y H:i', strtotime($order->paymentDate)) : 'N/A';
            $totalForOrder = $this->getApi()->getOrderManager()->getTotalForOrderById($order->id);
            ?>
            <div class=''>
                <div class="row row_payment_status_line ">
                    <div class="col col_date"> <? echo date('d.m.Y h:i', strtotime($order->rowCreatedDate)); ?> </div>
                    <div class="col col_productname"> <? echo $this->getPaymentType($order); ?></div>
                    <div class="col col_value"> <? echo $totalForOrder; ?></div>
                    <div class="col col_value odd"> <? echo $paymentDate; ?></div>
                    <div class="col col_balance"> 
                        <? if ($order->status != 7) {
                            echo "<div style='color: red;'><i class='fa fa-warning'></i> ".($totalForOrder * -1)."</div>";
                        } else {
                            echo "<div style='color: green;'><i class='fa fa-check'></i></div>";
                        }
                        ?>
                    </div>
                    <div class="col col_orderid odd"> <? echo $order->incrementOrderId; ?> </div>
                    <div class="col col_action">
                        <div class="gs_shop_small_icon fa fa-gear toggle_action_menu"></div>
                        <div class="gs_shop_small_icon fa fa-search-plus showOrderSummary" orderid="<? echo $order->id; ?>" title='<? echo $this->__f("Show order"); ?>'></div>
                        <div class="ordermenu">

                            <?
                            if ((!count($order->creditOrderId) && !$order->isCreditNote) || !$order->closed ) {
                            ?>
                            <div class='entry' gsclick="creditOrDeleteOrder" orderid="<? echo $order->id; ?>">
                                <?
                                if ($order->closed) {  
                                ?>
                                    <i class="fa fa-history"></i> <? echo $this->__f("Credit order"); ?>
                                <?
                                } else {?>
                                    <i class="fa fa-trash"></i> <? echo $this->__f("Delete order"); ?>
                                <?
                                }
                                ?>
                            </div>
                            <?
                            }
                            ?>

                            <?
                            if ($order->status != 7) {
                                ?>
                                <div class='entry showmarkorderaspaid' orderid="<? echo $order->id; ?>">
                                    <i class="fa fa-dollar"></i> <? echo $this->__f("Mark order as paid"); ?>
                                </div>
                                <?
                            }
                            ?>

                            <a href='/pms.php?page=orderviewpage&orderid=<? echo $order->id; ?>' target='_blank'>
                                <div class='entry' orderid="<? echo $order->id; ?>">
                                    <i class="fa fa-arrow-right"></i> <? echo $this->__f("Open"); ?>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <?
        
        }
   }
    ?>
</div>

<br/>
<br/>
<div>
    <div class='insideheader'>Detailed order summary for <? echo $room->guests[0]->name; ?></div>
    
    <?
    if ($this->shouldShowPager($distinctDates)) {
        $distinctMonthsAndYears = $this->getDistinctMonthsAndYears($distinctDates);
        sort($distinctMonthsAndYears);
        
    ?>
        <div>
            <? echo $this->__f("Filter by month").": "; ?>
            <select class='gsniceselect1 filterbymonth'>
                <?
                echo "<option value='$distinct'>".$this->__f("All")."</option>";
                foreach ($distinctMonthsAndYears as $distinct) {
                    $name = $this->translateMonthAndYear($distinct);
                    echo "<option value='$distinct'>$name</option>";
                }
                ?>    
            </select>
            
        </div>
    <?
    }
    ?>
    
    <?
    $totalRemainingGuestOwe = 0;
    usort($summary->rows, array("ns_f8cc5247_85bf_4504_b4f3_b39937bd9955\PmsBookingRoomView", "sortSummaryRowByDate"));
    ?>
    <div class="row row_payment_status_line header">
        <div class="col col_date"></div>
        <div class="col col_productname"></div>
        <div class="col col_value"><? echo $this->__f("Price"); ?></div>
        <div class="col col_value odd"><? echo $this->__f("Orders"); ?></div>
        <div class="col col_balance large"><? echo $this->__f("Balance"); ?></div>
    </div>

    <?
    
    $totalMissing = 0;
    $totalPaid = 0;
    $prevDate = "";
    $i = 0;
    
    foreach ($summary->rows as $row) {
        if ($row->date != $prevDate ) {
            $i++;
            $prevDate = $row->date;
        }
        
        $oddrow = $i%2 ? "oddrow" : "evenrow";
        $product = $this->getProduct($row->createOrderOnProductId);
       
        $balance = 0;
        $remaining = ($row->priceInBooking * $row->countFromBooking) - $row->actuallyPaidAmount;
        $allOk = round($remaining, 0) == 0;
        $balance += $remaining;
        $missingInOrders = ($row->createdOrdersFor * $row->countFromOrders) - ($row->priceInBooking * $row->countFromBooking);
        $orderColor = $missingInOrders != 0 ? '#ff7a00' : 'green';
        $paymentColor = $remaining != 0 ? 'red' : 'green';
        
        $totalMissing += $missingInOrders;
        $totalPaid += $remaining;
        ?>
    
        <div class="row row_payment_status_line <? echo $oddrow; ?>" date='<? echo $row->date; ?>'>
            <div class="col col_date"><? echo $row->date; ?></div>
            <div class="col col_productname"><? echo $product->name; ?></div>
            <div class="col col_value"><? echo round(($row->priceInBooking * $row->countFromBooking),2); ?></div>
            <div class="col col_value odd"><? echo round(($row->createdOrdersFor * $row->countFromOrders),2); ?></div>
            <div class="col col_balance large" style='color: <? echo $orderColor; ?>'>
                <? 
                if ($orderColor == '#ff7a00') {
                    echo "<i class='fa fa-warning' title='You need to create order for this payment, click start payment process'></i> ";
                }
                $roundedValue = round($missingInOrders,2);
                if ($roundedValue == 0) {
                    echo "<i class='fa fa-check'></i>";
                } else {
                    echo $roundedValue;
                }
                ?>
            </div>
        </div>
        <?
        
    }
    
    if ($this->shouldShowPager($distinctDates)) {
        ?>
        <script>   
            $(document).ready(function() {
                app.PmsBookingRoomView.selectLastOrdersDetailedMonth('<? echo $room->pmsBookingRoomId; ?>');
            });
        </script>
        <?
    }
?>

</div>
<br/>
<br/>
<br/>
<div class="markaspaidwindow">
    <div class="innner_area">
        
        <div class="closebutton"><i class="fa fa-close"></i></div>
        
        <div class="inner_work_area">
            
        </div>
    </div>
    
</div>


<div class="information" style="margin-bottom: 30px; border: solid 1px #DDD; padding: 10px; background-color: #feffc1; text-align: center">
    This version is in early development phase, its just for preview but we will be doing lots of development on this during the upcoming days.
    <div class="gs_shop_small_icon" gsclick="switchToOldVersion">Go back to old version</div>
</div>
