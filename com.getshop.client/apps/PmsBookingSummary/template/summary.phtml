<?php
/* @var $this \ns_46b52a59_de5d_4878_aef6_13b71af2fc75\PmsBookingSummary */
$configuration = $this->getApi()->getPmsManager()->getConfiguration($this->getSelectedName());
$booking = $this->getApi()->getPmsManager()->getCurrentBooking($this->getSelectedName());
$items = $this->getApi()->getBookingEngine()->getBookingItemTypes($this->getSelectedName());
$items2 = array();
foreach($items as $item) {
    $items2[$item->id] = $item;
}
$items = $items2;
$addonsAdded = array();
$bookingitems = $this->getApi()->getBookingEngine()->getBookingItems($this->getSelectedName());
foreach($bookingitems as $item) {
    $bookingitems[$item->id] = $item;
}
echo "<br>";
$addonsText = $this->getConfigurationSetting("heading_summary");
if(!$addonsText) {
    $addonsText = $this->__w("Rooms selected");
}
$startingFromText = $this->__w("Starting from");

echo "<h3 class='bottomborder'>" . $addonsText . "</h3>";
foreach($booking->rooms as $room) {
    if($room->addedByRepeater || $room->isAddon) {
        continue;
    }
    printRoomSummaryRow($room, $items, $booking, $addonsAdded, $bookingitems, $startingFromText);
}

if($configuration->supportMoreDates) {
    $this->includefile("addmoredates");
    if($this->hasRoomsThatCanNoBeAdded($booking)) {
        echo "<span class='unavailableroomwarning'>";
        echo $this->__w("You got rooms that are not available in the selected time periode.");
        echo "</span>";
        foreach($booking->rooms as $room) {
            if(!$room->addedByRepeater && !$room->isAddon) {
                continue;
            }
            if($room->canBeAdded) {
                continue;
            }
            printRoomSummaryRow($room, $items, $booking, $addonsAdded, $bookingitems, $startingFromText);
        }
    }
    
    echo "<div class='repatingroomlist'>";
    foreach($booking->rooms as $room) {
        if(!$room->addedByRepeater) {
            continue;
        }
        if(!$room->canBeAdded) {
            continue;
        }
        printRoomSummaryRow($room, $items, $booking, $addonsAdded, $bookingitems, $startingFromText);
    }
    echo "</div>";
}

$printAddons = false;
foreach($booking->addons as $addon) {
    if($addon) {
        $printAddons = true;
    }
}

echo "<br>";
foreach($booking->rooms as $room) {
    if(!isset($prices[$room->taxes])) {
        $prices[$room->taxes] = 0;
    }
    $prices[$room->taxes] += ($room->price*$room->count);
}

$bottom = "<h3 class='bottomborder'> " . $this->__w("Total") . "</h3>";
$total = 0;
foreach($prices as $taxgroup => $price) {
    $taxes = $price - ($price / (($taxgroup + 100) / 100));
    $total += $price;
    if($taxes > 0) {
        $bottom .= "<div class='itemrow'>";
        $bottom .= "MVA " . $taxgroup . "% <span class='price'>" . round($taxes) . " kr </span>";
        $bottom .= "</div>";
    }
}
if($total > 0) {
    $bottom .= "<div class='itemrow ' style='padding-top: 10px;'>";
    $bottom .= "Totalt <span class='price'>" . round($total) . " kr </span>";
    $bottom .= "</div>";
}
if($total > 0) {
    echo $bottom;
}
?>

<?
$addonsText = $this->getConfigurationSetting("heading_addons");
if(!$addonsText) {
    $addonsText = $this->__w("Addons");
}
$addons = "<h3 class='bottomborder'>$addonsText</h3>";
$addonsFound = false;
foreach($items as $item) {
    if(key_exists($item->id, $addonsAdded)) {
        continue;
    }
    if($item->addon > 0) {
        $addonsFound = true;
        $addons .= "<div class='itemrow ' itemid='".$item->id."' style='padding-top: 10px;'>";
        $checked = "";
        if(in_array($item->id, $booking->bookingEngineAddons)) {
            $checked = "CHECKED";
        }
        $addons .= "<input type='checkbox' itemid='".$item->id."' class='addonselection' style='float:right;' $checked>";
        $addons .= $item->name;
        $addons .= "</div>";
    }
}
if($addonsFound) {
    echo $addons;
}


function printRoomSummaryRow($room, $items, $booking, $addonsAdded, $bookingitems, $startingFromText) {
/* @var $room core_pmsmanager_PmsBookingRooms */
    
    if($room->isAddon) {
//        return;
    }
    
    $price = $room->price * $room->count;
    $canNotBeAded = "";
    if(!$room->canBeAdded) {
        $canNotBeAded = "cantbeadded";
    }
    echo "<div class='itemrow $canNotBeAded'>";
    echo "<i class='fa fa-trash-o removeAddon bookedaction' itemtypeid='".$room->pmsBookingRoomId."'></i> ";
    $addonsAdded[$room->bookingItemTypeId] = true;
    echo "<span class='itemname'>";
    if($room->bookingItemId) {
        echo $bookingitems[$room->bookingItemId]->bookingItemName;
    } else {
        echo $items[$room->bookingItemTypeId]->name;
    }
    echo "</span>";
    if($price > 0) {
        echo "<span class='price'>" . round($price) . " kr </span>";
    }
    $date =$room->date;
    
    if(!$date->end) {
        echo $startingFromText . " ";
    }
    echo "<span>" . date("d.m.Y H:i", strtotime($date->start));
    if($date->end) {
         echo " - " . date("d.m.Y H:i", strtotime($date->end));
    }
    echo "</span>";
    echo "</div>";    
}

?>