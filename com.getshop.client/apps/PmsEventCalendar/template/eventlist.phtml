<?php
/* @var $this ns_27e174dc_b08c_4bf7_8179_9ea8379c91da\PmsEventCalendar */
$cats = $this->getCategories();
$datelist = array();
$indexrange = array();
foreach($this->getEventList() as $eventEntry) {
    $j = 0;
    foreach($eventEntry->dateRanges as $idx => $range) {
        $start = strtotime($range->start);
        $datelist[] = $eventEntry;
        $sortList[] = $start;
        $indexrange[] = $j;
        $j++;
    }
}

asort($sortList);

$today = strtotime(date("d.m.Y 06:00", time()));

echo "<table>";
$i = 0;
foreach($sortList as $idx => $date) {
    if($date < $today) {
        continue;
    }
    
    $dateidx = $indexrange[$idx];
    
    $eventEntry = $datelist[$idx];
    if(!$eventEntry->starttime) {
        $eventEntry->starttime = date("H:i", strtotime($eventEntry->dateRanges[0]->start));
    }
    $title = $eventEntry->title;
    $starttime = $eventEntry->starttime;
    $shortDesc = $eventEntry->shortdesc;
    $day = date("Y-m-d", $date);
    
    if(isset($eventEntry->overrideEntries->{$day})) {
        $title = $eventEntry->overrideEntries->{$day}->title;
        $starttime = $eventEntry->overrideEntries->{$day}->starttime;
        $shortDesc = $eventEntry->overrideEntries->{$day}->shortdesc;
    }
    if(isset($_GET['list']) && $_GET['list'] == "tiny") {
        echo "<tr>";
        echo "<td valign='top' width='50'><div>".date("d.", $date). "<br>" . date("M", $date) ."</div></td>";
        echo "<td valign='top' class='listtext'>";
        echo $title . "<br>";
        echo $starttime;
        echo "</td>";
        echo "</tr>";
    } else {
        echo "<tr>";
        echo "<td valign='top' class='datecol' width='90'><div>".date("d.", $date). " " . date("M", $date) ."</div><div>".$starttime."</div></td>";
        echo "<td valign='top' class='listtext'>";
        $shortId = explode("-", $eventEntry->id);
        $edit = "";
        if($this->isEditorMode()) {
            $edit = "<i class='fa fa-trash-o deleteevent' eventid='".$eventEntry->id."' ></i> ";
            $edit .= "<a href='?page=".$this->getPage()->javapage->id."&eventid=".$eventEntry->id."'><i class='fa fa-pencil-square' title='Endre alle eventer i denne serien'></i></a> ";
            $edit .= "<a href='?page=".$this->getPage()->javapage->id."&eventid=".$eventEntry->id."&time=$date'><i class='fa fa-edit' title='Endre dette enkelteventet'></i></a> ";
        }
        echo "<h2>" . $edit . "<a href='?page=".$this->getPage()->javapage->id."&readevent=".$shortId[0]."&time=".$date."'>" . $title  . " <span style='font-size: 12px;'>les mer</span></a></h2>";

        if(!isset($eventEntry->roomNames[$dateidx])) {
            print_r($eventEntry->roomNames);
        }
        echo "<div style='margin-top: 5px; margin-bottom: 5px;'>";
        echo  $eventEntry->roomNames[$dateidx];
        echo "<span class='arrangedby'>" . ", " . $eventEntry->arrangedBy . "</span>";
        echo "</div>";
        if(isset($cats[$eventEntry->category])) {
//            echo "<div><span class='cat'>" . $cats[$eventEntry->category] . "</span></div>";
        }
        echo nl2br(trim($shortDesc)) . "<br><br>";
        echo "</td>";
        echo "<tr>";
    }
    $i++;
    if($i > 500) {
        break;
    }
    if(isset($_GET['list']) && $_GET['list'] == "tiny" && $i == 3) {
        break;
    }
}
echo "</table>";
if(isset($_GET['list']) && $_GET['list'] == "tiny") {
    ?>
    <style>
        body { background-color: #e2e0df !important; }
.gsarea[area="body"] .gs_page_width.gsinner { background-color: #e2e0df !important; }
    </style>
    <?php
}

?>
