<?php
 /* @var $this ns_7e828cd0_8b44_4125_ae4f_f61983b01e0a\PmsManagement */
$booking = $this->getSelectedBooking();
$user = $this->getApi()->getUserManager()->getUserById($booking->userId);
$instances = $this->getApi()->getStoreApplicationPool()->getActivatedPaymentApplications();
if($instances) {
    $instances2 = array();
    foreach($instances as $instance) {
        $ns = "ns_" . str_replace("-","_", $instance->id) ."\\".$instance->appName;
        $instances2[$ns] = $instance;
    }
    $instances = $instances2;
}
$avtalegiro = $this->getApi()->getStoreApplicationPool()->getApplication("8f5f7f8f-de42-4867-82cc-63eb0cb55fa1");
$config = $this->getConfigurationToUse();
?>
<h2>Form filled out when registering</h2>
<?
foreach($booking->registrationData->resultAdded as $key => $value) {
    $name = "";
    foreach($booking->registrationData->data as $val) {
        if($val->name == $key) {
            $name = $val->title;
            if(!$val->title || $val->type == "radio") {
                $name = $key;
            }
        }
    }
    if($key == "agreetoterms") {
        $name = "Agreed to terms and condition";
    }
    if($key == "choosetyperadio") {
        $name = "Registration type";
    }
    if(!$name) {
        continue;
    }
?>
    <span class='roomprefix'><? echo $name; ?></span>
    <span class='roompostfix'><? echo $value; ?></span>
    <div style='clear:both;'></div>
<?php
}
if(sizeof($booking->registrationData->contactsList) > 0) {
    echo '<h2>Kontaktliste</h2>';
    echo "<table cellspacing='0' cellpadding='0'>";
    echo "<tr>";
    echo "<th>Name</th>";
    echo "<th>Email</th>";
    echo "<th>Phone</th>";
    echo "<th>Title</th>";
    echo "</tr>";
    foreach($booking->registrationData->contactsList as $contact) {
        echo "<tr>";
        echo "<td>" . $contact->name . "</td>";
        echo "<td>" . $contact->email . "</td>";
        echo "<td>" . $contact->phone . "</td>";
        echo "<td>" . $contact->title . "</td>";
        echo "</tr>";
    }
    echo "</table>";
    ?>
    <?php
}

?>

<div class='contactdata'>
    <h2>User data</h2>
    <div style='padding-left: 10px;'>
        <span class='roomprefix'>User id</span>
        <span class='roompostfix'><a onclick="thundashop.common.hideInformationBox();app.Users.gssinterface.showUser('<? echo $user->id; ?>')"><? echo $user->customerId; ?></a></span>
        <div style='clear:both;'></div>
        
        <div style='clear:both;'></div>
        <? if($user->birthDay) { ?>
            <span class='roomprefix'>Birthday</span>
            <span class='roompostfix'><? echo $user->birthDay; ?></span>
            <div style='clear:both;'></div>
        <? }  ?>
        <? if($user->company && sizeof($user->company) > 0) { ?>
            <span class='roomprefix'>Company</span>
            <span class='roompostfix'>
            <? 
            foreach($user->company as $companyId) {
                $company = $this->getApi()->getUserManager()->getCompany($companyId);
                echo '<a onclick="thundashop.common.hideInformationBox();app.Company.gssinterface.showCompany(\''.$companyId.'\')">';
                echo $company->name;
                echo '</a>';
            }
            ?></span>
            <div style='clear:both;'></div>
        <? } ?>
        <?php if($avtalegiro) { 
            echo "<span class='roomprefix'>Avtalegiro</span>";
            echo "<span class='roompostfix'>";
            /* @var $autogiroapp ns_8f5f7f8f_de42_4867_82cc_63eb0cb55fa1\Avtalegiro */
            $autogiroapp = $this->getFactory()->getApplicationPool()->createInstace($avtalegiro);
            $link = $autogiroapp->createLink($user->id);
            echo "<a href='".$autogiroapp->createLink($user->id)."' target='_new'>Avtalegiro</a>";
            echo " - <a href='".$autogiroapp->createLink($user->id)."' target='_new'>Efaktura</a>";
            echo " - <a href='".$autogiroapp->createLink($user->id)."' target='_new'>Avtalegiro + efaktura</a>";
            echo "</span>";
            echo "<div style='clear:both;'></div>";
            ?>
        <? } ?>
        <div style='clear:both;'></div>
        <? if($instances) { ?>
            <span class='roomattribute'>
                    <span class='roomprefix'>
                        <i class='fa fa-edit'></i> Payment type
                    </span>
                <span class='roompostfix'>
                <span class="viewmode">
                        <?
                        if(!$user->preferredPaymentType || !isset($instances[$user->preferredPaymentType])) {
                            echo "User does not have a preferred payment type.. configure it in the setting panel, under settings.";
                        } else {
                            $appSettings = $instances[$user->preferredPaymentType];
                            $instance = $this->getFactory()->getApplicationPool()->createInstace($appSettings);
                            echo $appSettings->appName;
                        }
                        ?>
                    </span>
                    <span class="editmode" gstype='form' method="setNewPaymentType">
                        <input type='hidden' value='<? echo $booking->id; ?>' gsname='bookingid'>
                        <select gsname="newtype">
                            <?php 
                            foreach($instances  as $ns => $instance) {
                                $selected = "";
                                if($ns == $user->preferredPaymentType) {
                                    $selected = "SELECTED";
                                }
                                echo "<option value='".$ns."' $selected>".$instance->appName."</option>";
                            }
                            ?>
                        </select>
                        <span class='pmsbutton tiny' gstype='submitToInfoBox'>Change</span>
                    </span>
                </span>
            </span>
            <div style='clear:both;'></div>
        <? } ?>
    </div>
</div>