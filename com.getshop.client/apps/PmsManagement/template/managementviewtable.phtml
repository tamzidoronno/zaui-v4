<?php
/* @var $this ns_7e828cd0_8b44_4125_ae4f_f61983b01e0a\PmsManagement */
$filter = $this->getSelectedFilter();
$bookings = $this->getApi()->getPmsManager()->getAllBookings($this->getSelectedName(), $filter);
$types = $this->getApi()->getBookingEngine()->getBookingItemTypes($this->getSelectedName());
$items = $this->getApi()->getBookingEngine()->getBookingItems($this->getSelectedName());
foreach($items as $item) {
    $items[$item->id] = $item;
}
foreach($types as $type) {
    $types[$type->id] = $type;
}

$rows = 0;
echo "<table width='100%' cellspacing='0' cellpadding='0'>";
echo "<tr>";
echo "<th></th>";
echo "<th>Start</th>";
echo "<th>End</th>";
echo "<th>Visitor</th>";
echo "<th>Room</th>";
echo "<th align='center'><center>State</center></th>";
echo "</tr>";
if(!$bookings) {
    $bookings = array();
}
foreach($bookings as $booking) {
    foreach($booking->rooms as $room) {
        $rows++;
        if($types[$room->bookingItemTypeId]->addon > 0) {
            continue;
        } 
        
        echo "<tr>";
        echo "<td style='width:70px;'>";
        echo "<i class='fa fa-info moreinformationaboutbooking actions' roomid='".$room->pmsBookingRoomId."' bookingid='".$booking->id."'></i> ";
        echo "</td>";
        echo "<td>";
        echo date("d.m.Y H:i", strtotime($room->date->start));
        echo "</td>";
        echo "<td>";
        if($room->date->end) {
            //Dont show end date if this is a atleast 75 years booking
            if(((strtotime($room->date->end) - strtotime($room->date->start)) /86400) < 20000) {
                echo date("d.m.Y H:i", strtotime($room->date->end));
            }
        }
        echo "</td>";
        echo "<td>";
        foreach($booking->rooms as $room2) {
            $addons = array();
            if($types[$room2->bookingItemTypeId]->addon > 0) {
                $addons[] = $types[$room2->bookingItemTypeId]->name;
            }
            if($addons) {
                echo "<i class='fa fa-plus-circle' title='".  join(",", $addons)."'></i> ";
            }
        }
        foreach($room->guests as $guest) {
            echo $guest->name . " - " . $guest->email . " - " . $guest->phone . "<br>";
        }
        $user = $this->getApi()->getUserManager()->getUserById($booking->userId);
        echo "<div style='padding-top: 5px;'>";
        echo "<span class='secondary_text'>Room type " . $types[$room->bookingItemTypeId]->name . "</span>, ";
        if($user) {
            echo "<span class='secondary_text'>registered by " . $user->fullName . "</span>";
        }
        echo "<span class='secondary_text'>";
        if($booking->confirmed) {
            echo ", confirmed ";
        } else {
            echo ", not confirmed ";
        }
        echo "</span>";

        echo "<span class='secondary_text' style='float:right;'>Registered " . $booking->rowCreatedDate . "</span>";
        echo "</div>";
        echo "</td>";
        echo "<td align='center'>";
        if($room->booking->bookingItemId) {
            echo $items[$room->booking->bookingItemId]->bookingItemName;
        }
        echo "</td>";
        echo "<td align='center'>";
        switch($booking->state) {
            case "0":
                echo "Booking";
                break;
            case "1":
                echo "Booked";
                break;
            case "2":
                echo "Deleted";
                break;
        }
        echo "</td>";
        echo "</tr>";
    }
} 
echo "</table>";
echo "<br>";
echo "$rows rows in total.";
?>