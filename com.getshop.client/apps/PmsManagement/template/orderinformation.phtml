<? 
/* @var $this ns_7e828cd0_8b44_4125_ae4f_f61983b01e0a\PmsManagement */
$booking = $this->getSelectedBooking();
/*
 * public static int CREATED = 1;
    public static int WAITING_FOR_PAYMENT = 2;
    public static int PAYMENT_FAILED = 3;
    public static int COMPLETED = 4;
    public static int CANCELED = 5;
    public static int SENT = 6;
    public static int PAYMENT_COMPLETED = 7;
    public static int COLLECTION_FAILED = 8;
    public static int NEEDCOLLECTING = 9;
 */

$paymentTypes = array();
$paymentTypes[1] = "CREATED";
$paymentTypes[2] = "WAITING FOR PAYMENT";
$paymentTypes[3] = "FAILED";
$paymentTypes[4] = "COMPLETED";
$paymentTypes[5] = "CANCELED";
$paymentTypes[6] = "SENT";
$paymentTypes[7] = "PAYMENT COMPLETED";
$paymentTypes[8] = "COLLECTION_FAILED";
$paymentTypes[9] = "NEEDCOLLECTING";
$paymentTypes[10] = "SENTTOINVOICE";

$pricetypes = array();
$pricetypes[1] = "Daily";
$pricetypes[2] = "Monthly";
$pricetypes[3] = "Weekly";
$pricetypes[4] = "Per minute";
$pricetypes[5] = "Per hour";
$pricetypes[6] = "Per seconds";
$pricetypes[7] = "Progressive";
$pricetypes[8] = "Interval";

$instances = $this->getApi()->getStoreApplicationPool()->getActivatedPaymentApplications();
$instances2 = array();
if($instances) {
    foreach($instances as $instance) {
        $instances2[$instance->id] = $instance;
    }
    $instances = $instances2;
}

$items = $this->getApi()->getBookingEngine()->getBookingItems($this->getSelectedName());
$items = $this->indexList($items);

$user = $this->getApi()->getUserManager()->getUserById($booking->userId);
$invoiceEmail =  $user->emailAddress;
if($user->emailAddressToInvoice) {
    $invoiceEmail = $user->emailAddressToInvoice;
}
$phonePrefix = $user->prefix;
$phoneNumber = $user->cellPhone;
$bookerName = $user->fullName;
?>

<div class='orderinformation'>
    <h2>Orders</h2>
</div>

<span class='roomattribute'>
    <span class='roomprefix'>
        <i class='fa fa-edit'></i> Price type
    </span>
    <span class='roompostfix'>
        <span class='viewmode'>
            <? echo $pricetypes[$booking->priceType]; ?>
        </span>
        <span class='editmode' gstype='form' method='changePriceType'>
            <input type='hidden' value='<? echo $booking->id; ?>' gsname='bookingid'>
            <?php
            echo "<select gsname='pricetype'>";
            foreach($pricetypes as $idx => $value) {
                echo "<option value='$idx'>$value</option>";
            }
            echo "</select>";
            ?>
            <span class='pmsbutton tiny' gstype='submitToInfoBox'>Change</span>
        </span>
    </span>
</span>
<div style='clear:both;'></div>


<?php
if($booking->orderIds) {
    foreach($booking->orderIds as $orderId) {
        $order = $this->getApi()->getOrderManager()->getOrder($orderId);
        $result[$order->incrementOrderId] = $order;
    }
    ksort($result);
    
    $totalAmount = 0;
    $totalAmountEx = 0;
    
    echo "<table cellspacing='0' cellpadding='0' width='100%'>";
    echo "<tr>";
    echo "<th>Orderid</th>";
    echo "<th>Order</th>";
    echo "<th>Price</th>";
    echo "<th>Payment status</th>";
    echo "<th>Payment type</th>";
    echo "<th>Closed</th>";
    echo "<th>Credit</th>";
    echo "<th>Update</th>";
    echo "</tr>";
    foreach($result as $order) {
        $total = $this->getApi()->getOrderManager()->getTotalAmount($order);
        $totalEx = $this->getApi()->getOrderManager()->getTotalAmountExTaxes($order);
        
        $totalAmount += $total;
        $totalAmountEx += $totalEx;
        
        $roomIds = array();
        foreach($order->cart->items as $item) {
            if(isset($item->product->externalReferenceId)) {
                $roomIds[] = $item->product->externalReferenceId;
            }
        }
        
        $guests = array();
        foreach($booking->rooms as $room) {
            if(in_array($room->pmsBookingRoomId, $roomIds)) {
                $guests = array_merge($guests, $room->guests);
            }
        }
        
        
        echo "<tr orderid='".$order->id."'>";
        echo "<td><a class='showorderbutton' orderid='".$order->id."'>" . $order->incrementOrderId . "</a></td>";
        echo "<td>" . date("d.m.Y", strtotime($order->rowCreatedDate))  . "</td>";
        echo "<td>" . round($totalEx) . "<br><span style='color:#bbb'>" . round($total) . "</span></td>";
        echo "<td>";
        if(@!$order->closed) {
            echo "<div>";
            echo "<selecT class='orderstatus'>";
            foreach($paymentTypes as $id => $val) {
                $selected = ($id == $order->status) ? "selected" : "";
                echo "<option value='$id' $selected>$val</option>";
            }
            echo "</selecT>";
            echo "</div>";
        } else {
            echo $paymentTypes[$order->status];
        }
        echo "</td>";
        echo "<td>";
        
        
        echo "<span class='sendpaymentlinkbox' gstype='form' method='sendPaymentLink'>";
        echo "<div style='padding-bottom: 10px;'>";
        echo "<i class='fa fa-close closesendpaymentlink' style='float:right;'></i>";
        echo "Send payment link";
        echo "</div>";
        echo "<input type='hidden' value='".$booking->id."' gsname='bookingid'>";
        echo "<input type='hidden' value='".$order->id."' gsname='orderid'>";
        echo "<div>";
        
        echo "<select style='width:100%; margin-bottom: 5px;' class='sendlinktouser'>";
        echo "<option value='$phonePrefix:$phoneNumber:$invoiceEmail'>Booker : $bookerName</option>";
        foreach($guests as $guest) {
            /* @var $guest core_pmsmanager_PmsGuests */
            if(!$guest->name) {
                continue;
            }
            $pref = $guest->prefix;
            $phone = $guest->phone;
            $email = $guest->email;
            echo "<option value='$pref:$phone:$email'>Guest : " . $guest->name . "</option>";
        }
        echo "</select><br>";
        echo "<input type='txt' value='".$invoiceEmail."' placeholder='Email' gsname='bookerEmail' style='width:100%; margin-bottom: 5px;box-sizing:border-box;'><br>";
        echo "<input type='txt' value='+".$phonePrefix."' placeholder='bookerPrefix' gsname='bookerPrefix' style='width: 30px;'>";
        echo "<input type='txt' value='".$phoneNumber."' placeholder='bookerPhone' gsname='bookerPhone' style='width: 80px;'><input type='button' gstype='submitToInfoBox' gsvalue='sendtobooker' value='Send link'>";
        echo "</div>";
        
        echo "</span>";
        
        
        if(@!$order->closed) {
            echo "<div>";
            echo "<select class='paymenttype'>";
            foreach($instances as $id => $app) {
                $selected = ($this->isPaymentType($order->payment->paymentType, $app)) ? "selected" : "";
                echo "<option value='".$this->createPaymentTypeText($app)."' $selected>".$app->appName."</option>";
            }
            echo "</select>";
            echo "</div>";
            if($order->status <= 5 && $total > 0) {
                if(stristr($order->payment->paymentType, "dibs")) {
                    echo "<a href='/?page=cart&payorder=" . $order->id."'>pay</a> - <span style='cursor:pointer; color:blue' class='sendpaymentlink' orderid='".$order->id."' bookingid='".$booking->id."'>Send payment link</span>";
                }
            }
            if(stristr($order->payment->paymentType, "invoice")) {
                echo "<span style='cursor:pointer; color:blue' class='sendinvoice' orderid='".$order->id."' bookingid='".$booking->id."'>Send invoice</span>";
            }
        } else {
            echo $this->translatePaymenttype($order->payment->paymentType, $instances);
            echo "<br><span style='cursor:pointer; color:blue' class='sendreciept' orderid='".$order->id."' bookingid='".$booking->id."'>Send reciept</span>";
            echo "<br><a href='/downloadInvoice.php?orderId=8afb7b51-2e86-4fdb-b48e-a3b8e9642208&incrementalOrderId=108460' target='_fdasf'><span style='cursor:pointer; color:blue' class='sendreciept' orderid='".$order->id."' bookingid='".$booking->id."'>download</span></a>";
        }
        echo "<span class='sendinvoicebox' gstype='form' method='sendInvoice'>";
        echo "<input type='hidden' value='".$booking->id."' gsname='bookingid'>";
        echo "<input type='hidden' value='".$order->id."' gsname='orderid'>";
        echo "<input type='txt' value='".$invoiceEmail."' placeholder='Email' gsname='email'><span class='pmsbutton' gstype='submitToInfoBox'>Send</span>";
        echo "</span>";
        
        echo "</td>";
        echo "<td align='center'>";

        if(@$order->closed) {
            echo "<i class='fa fa-check'>";
        } else {
            echo "<i class='fa fa-close'>";
        }
        echo "</td>";
        if(@$order->closed && !@$order->isCreditNote) {
            echo "<td class='doCreditOrder'>Credit order</td>";
        } else {
            echo "<td></td>";
        }
        
        if(@!$order->closed) {
            echo "<td><input type='button' value='Update' class='updateorderrow'></td>";
        }
        
        echo "</tr>";
    }
    
    echo "<tr>";
    echo "<td></td>";
    echo "<td></td>";
    echo "<td>".round($totalAmountEx)."<br><span style='color:#bbb'>".round($totalAmount)."</span></td>";
    echo "<td></td>";
    echo "<td></td>";
    echo "<td></td>";
    echo "<td></td>";
    echo "<td></td>";
    echo "</tr>";
    
    echo "</table>";
} else {
    echo "<h2>No orders added to this booking yet.</h2>";
    echo "Please create an order below first.";
}

?>
<br>
<h2>Invoice information</h2>
<div gstype="form" method="updateInvoiceNote" style='text-align:right;'>
    <input type='hidden' value='<? echo $booking->id; ?>' gsname='bookingid'>
    <textarea gsname='invoicenote' style="width:100%;height: 50px;"><?php echo $booking->invoiceNote; ?></textarea><br>
    <span class='pmsbutton' gstype="submitToInfoBox">Update invoice note</span>
</div>
<div gstype="form" method="createNewOrder">
    <input type='hidden' value='<? echo $booking->id; ?>' gsname='bookingid'>

    <?php
    $endDate = time();
    foreach($booking->rooms as $room) {
        if($endDate < strtotime($room->date->end)) {
            $endDate = strtotime($room->date->end);
        }
    }
    if(isset($_POST['data']['endingAt'])) {
        $endDate = strtotime($_POST['data']['endingAt']);
    }
    $invoiceRoomId = "";
    if(isset($_POST['data']['roomId'])) {
        $invoiceRoomId = $_POST['data']['roomId'];
    }
    
    $endingAt = date("d.m.Y", $endDate);
    
    $config = $this->getApi()->getPmsManager()->getConfiguration($this->getSelectedName());
    $filter = new \core_pmsmanager_NewOrderFilter();
    $filter->onlyEnded = false;
    $filter->prepayment = $config->prepayment;
    $filter->avoidOrderCreation = true;
    $filter->pmsRoomId = $invoiceRoomId;

    $filter->endInvoiceAt = $this->convertToJavaDate($endDate);
    $this->getApi()->getPmsManager()->createOrder($this->getSelectedName(), $booking->id, $filter);
    $cart = $this->getApi()->getCartManager()->getCart();

    echo "<br><h2>Next order preview (invoice until $endingAt)</h2>";
    $this->includeOrderGenerationPreview();

    echo "<br><label><input type='checkbox' gsname='preview' CHECKED> Update preview only</label><br>";
    echo "<label><input type='checkbox' gsname='appendToExisting' CHECKED> Append to existing order if possible.</label><br>";
    echo "<select gsname='roomId'>";
    echo "<option value=''>All rooms</option>";
    foreach($booking->rooms as $room) {
        $selected = "";
        if($invoiceRoomId && $invoiceRoomId == $room->pmsBookingRoomId) {
            $selected = "SELECTED";
        }
        $guestInfo = "";
        if($room->guests[0]->name) {
            $guestInfo = " guest : " . $room->guests[0]->name;
        }
        echo "<option value='".$room->pmsBookingRoomId."' $selected>" . $items[$room->bookingItemId]->bookingItemName . $guestInfo . "</option>";
    }
    echo "</select>";
    if(isset($booking->invoicedTo) && !$booking->invoicedTo) {
        $booking->invoicedTo = $booking->rooms[0]->date->start;
    }
    echo "<label style='display:inline-block;'><input type='text' gsname='endingAt' value='$endingAt' style='font-size: 18px; width: 100px;padding: 4px;' /></label>";
    echo "<span class='pmsbutton' gstype=\"submitToInfoBox\">Create new order</span>";
    ?>
</div>

<script>
    $("[gsname='endingAt']").datepicker({ dateFormat: "dd.mm.yy", changeMonth: true, changeYear: true, showButtonPanel: true });
</script>