<?php
/* @var $this ns_7e828cd0_8b44_4125_ae4f_f61983b01e0a\PmsManagement */
$booking = $this->getSelectedBooking();
$types = $this->getTypes();
$items = $this->getApi()->getBookingEngine()->getBookingItems($this->getSelectedName());
$items2 = array();
foreach ($items as $item) {
    $items2[$item->id] = $item;
}

$items = $items2;

$toPrint = array();
$addons = array();

foreach($booking->rooms as $room) {
    if($types[$room->bookingItemTypeId]->addon == 0) {
        $toPrint[] = $room;
    } else {
        $addons[] = $room;
    }
}

$prices = $this->getApi()->getPmsManager()->getPrices($this->getSelectedName(), $this->convertToJavaDate(time()), $this->convertToJavaDate(time()));
$config = $this->getApi()->getPmsManager()->getConfiguration($this->getSelectedName());
$dates = $this->getApi()->getPmsManager()->getDefaultDateRange($this->getSelectedName());
?>
<h2>Rooms booked</h2>
<span gstype="form" method='addRoomToBooking'>
    <input type='hidden' value='<? echo $booking->id; ?>' gsname='bookingid'>
    <input type='text' style='float:left; margin-right: 10px;' value='<?php echo date("d.m.Y H:i", strtotime($dates->start)); ?>' gsname='start'>
    <input type='text' style='float:left; margin-right: 10px;' value='<?php echo date("d.m.Y H:i", strtotime($dates->end)); ?>' gsname='end'>
    <select style='float:left; margin-right: 10px;' gsname='item'>
        <?php 
        foreach($items as $item) {
            /* @var $item core_bookingengine_data_BookingItem */
            echo "<option value='".$item->id."'>". $item->bookingItemName . "</option>";
        }
        ?>
    </select>
    <span class='pmsbutton' gstype='submitToInfoBox'>Add room</span>
</span>
<br><br>

<?php
$hasArx = false;
if($config->arxHostname) {
    $hasArx = true;
}
$hasPrices = false;

$arr = (array)$prices->dailyPrices;

if(($prices->defaultPriceType == 1 && !empty($arr)) || $prices->defaultPriceType != 1) {
     $hasPrices = true;
}

printRooms($toPrint, $types, $items, $booking->id, false, $hasPrices, $hasArx);

if(sizeof($addons) > 0) {
    echo '<h2>Addons</h2>';
    printRooms($addons, $types, $items, $booking->id, true, $hasPrices, $hasArx);
}

function printRooms($rooms, $types, $items, $bookingId, $addons, $hasPrices, $hasArx) {
    ?>
<table width='100%' cellspacing='0' cellpadding='0' class='guestoverviewtable'>
    <tr>
        <th width='10'></th>
        <th width='10'>Type</th>
        <th>Room</th>
        <th>Date start</th>
        <th>Date end</th>
        <th>Guest</th>
        <?php if(!$addons && $hasPrices) { ?>
            <th>Price</th>
            <th>Invoiced until</th>
        <?php } ?>
        <?php if($hasArx) { ?>
            <th>To arx</th>
        <?php } ?>
    </tr>

    <?php
    foreach ($rooms as $room) {
//        echo " - <span class='resetnotifications' roomid='".$room->pmsBookingRoomId."' bookingid='".$bookingId."'>reset notifications</span>";
        /* @var $room core_pmsmanager_PmsBookingRooms */
        $date = $room->date;
        ?>
        <tr>
            <td>
                <span gstype='form' method="removeRoom">
                    <input type='hidden' value='<? echo $bookingId; ?>' gsname='bookingid'>
                    <input type='hidden' value='<? echo $room->pmsBookingRoomId; ?>' gsname='roomid'>
                    <i class='fa fa-trash-o' gstype='submitToInfoBox'></i>
                </span>
            </td>
            <td>
                <span class='roomattribute'>
                    <span class='roompostfix'>
                        <span class="viewmode">
                            <? echo $types[$room->bookingItemTypeId]->name; ?>
                        </span>
                        <span class="editmode" gstype='form' method="setItemType">
                            <input type='hidden' value='<? echo $bookingId; ?>' gsname='bookingid'>
                            <input type='hidden' value='<? echo $room->pmsBookingRoomId; ?>' gsname='roomid'>
                            <select gsname='itemtype'>
                                <?php foreach ($types as $type) { ?>
                                    <?php $selected = "";
                                    if ($type->id == $room->bookingItemTypeId) {
                                        $selected = "SELECTED";
                                    }  ?>
                                    <option value='<? echo $type->id; ?>' <? echo $selected; ?>><? echo $type->name; ?></option>
                                <? }  ?>
                            </select>
                            <span class='pmsbutton tiny' gstype='submitToInfoBox'>Change</span>
                        </span>
                    </span>
                </span>
            </td>
            <td>
                    <span class='roomattribute'>
                        <span class='roompostfix'>
                            <span class="viewmode">
                                <?
                                if (!$room->booking->bookingItemId) {
                                    echo "Not assigned yet";
                                } else {
                                    $notifications = "notifications: " . join(",", $room->notificationsSent);
                                    echo "<span title='$notifications'>" . $items[$room->booking->bookingItemId]->bookingItemName . "</span>";
                                }
                                ?>
                            </span>
                            <span class="editmode" gstype='form' method='setBookingItem' >
                                <input type='hidden' value='<? echo $bookingId; ?>' gsname='bookingid'>
                                <input type='hidden' value='<? echo $room->pmsBookingRoomId; ?>' gsname='roomid'>
                                <select gsname='itemid'>
                                    <?php 
                                    foreach($items as $item) {
                                        $selected = "";
                                        if($types[$item->bookingItemTypeId]->addon > 0) {
                                            continue;
                                        }

                                        if($room->booking->bookingItemId == $item->id) {
                                            $selected = "SELECTED";
                                        }
                                        echo "<option value='".$item->id."' $selected>" . $item->bookingItemName . "</option>";
                                    }
                                    ?>
                                </select>
                                <span class='pmsbutton tiny' gstype='submitToInfoBox'>Change</span>
                            </span>
                        </span>
                    </span>
                </td>
                <td>
                <span class='roomattribute'>
                    <span class='roompostfix'>
                        <span class="viewmode">
                            <?php echo date("d.m.Y H:i", strtotime($date->start)); ?>
                        </span>
                        <span class='editmode' gstype='form' method="setNewStartDate">
                            <input type='hidden' value='<? echo $bookingId; ?>' gsname='bookingid'>
                            <input type='hidden' value='<? echo $room->pmsBookingRoomId; ?>' gsname='roomid'>
                            <input type='text' gsname='start' value='<? echo date("d.m.Y H:i", strtotime($room->date->start)); ?>'>
                            <span class='pmsbutton tiny' gstype='submitToInfoBox'>Change</span>
                        </span>
                    </span>
                </span>
            </td>
            <td>
                <span class='roomattribute'>
                    <span class='roompostfix'>
                        <span class="viewmode">
                            <?php 
                                if(date("d.m.Y", strtotime($date->start)) == date("d.m.Y", strtotime($date->end))) {
                                    echo date("H:i", strtotime($date->end));
                                } else {
                                    echo date("d.m.Y H:i", strtotime($date->end));
                                }
                                ?>
                        </span>
                        <span class='editmode' gstype='form' method="setNewEndDate">
                            <input type='hidden' value='<? echo $bookingId; ?>' gsname='bookingid'>
                            <input type='hidden' value='<? echo $room->pmsBookingRoomId; ?>' gsname='roomid'>
                            <input type='text' gsname='end' value='<? echo date("d.m.Y H:i", strtotime($room->date->end)); ?>'>
                            <span class='pmsbutton tiny' gstype='submitToInfoBox'>Change</span>
                        </span>
                    </span>
                </span>
            </td>
            <? if(!$addons && $hasPrices) { ?>
                <td>
                    <span class='roomattribute'>
                        <span class='roompostfix editGuestToggle'>
                            <span class="viewmode">
                                <?php
                                foreach ($room->guests as $guest) {
                                    echo $guest->name . " - " . $guest->email . " - +" . $guest->prefix . $guest->phone;
                                }
                                ?>
                            </span>
                            <span class="editmode" gstype='form' method="setGuests">
                                <input type='hidden' value='<? echo $bookingId; ?>' gsname='bookingid'>
                                <input type='hidden' value='<? echo $room->pmsBookingRoomId; ?>' gsname='roomid'>
                                <select gsname='numberofguests'>
                                <?php
                                for($i = 1; $i <= 20; $i++) {
                                    $selected = "";
                                    if($i == $room->numberOfGuests) {
                                        $selected = "SELECTED";
                                    }
                                    echo "<option value='$i' $selected>$i</option>";
                                }
                                ?>
                                </select><br>
                                <table>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                    </tr>
                                <?php for($i = 0; $i < 20; $i++) {
                                    $guest = new core_pmsmanager_PmsGuests();
                                    if(isset($room->guests[$i])) {
                                        $guest = $room->guests[$i];
                                    }
                                    echo "<tr class='guestrow_$i guestrow'>";
                                    echo "<td><input type='text' value='".$guest->name."' gsname='name_$i' style='width:100px;'></td>";
                                    echo "<td><input type='text' value='".$guest->email."' gsname='email_$i' style='width:100px;'></td>";
                                    echo "<td><input type='text' value='+".$guest->prefix."' gsname='prefix_$i' style='width:30px;float:left;'><input type='text' value='".$guest->phone."' gsname='phone_$i' style='float:left;width:70px;'></td>";
                                    echo "</tr>";
                                }
                                ?>
                                </table>
                                <span class='pmsbutton tiny' gstype='submitToInfoBox'>Change</span>
                            </span>
                        </span>
                    </span>
                </td>
            <? } ?>
                <td>
                    <span class='roomattribute'>
                        <span class='roompostfix'>
                            <span class='viewmode'>
                                <? echo $room->price; ?>
                            </span>
                            <span class='editmode' method='changePrice' gstype='form'>
                                <input type='hidden' value='<? echo $bookingId; ?>' gsname='bookingid'>
                                <input type='hidden' value='<? echo $room->pmsBookingRoomId; ?>' gsname='roomid'>
                                <input type='text' gsname='price' value='<? echo $room->price; ?>'>
                                <span class='pmsbutton tiny' gstype='submitToInfoBox'>Change</span>
                            </span>
                        </span>
                    </span>
                </td>
                <td>
                    <? 
                    if($room->invoicedTo) {
                        echo date("d.m.Y" , strtotime($room->invoicedTo)); 
                    } else {
                        echo " - ";
                    }
                    ?>
                </td>
                <?php if($hasArx) { ?>
                    <td align='center'>
                        <span class='roomattribute'>
                            <span class='roompostfix'>
                                <span class='viewmode'>
                                    <? if($room->addedToArx) {
                                        echo "yes";
                                    } else {
                                        echo "no";
                                    }
                                    ?>
                                </span>
                            </span>
                        </span>
                    </td>
                <? } ?>
        </tr>
    <?php } ?>
</table>
<?php
}

?>
